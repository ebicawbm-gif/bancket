<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰ Sample J</title>

  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --danger:#dc2626; --warn:#d97706; --ok:#16a34a;
      --shadow: 0 10px 28px rgba(0,0,0,.08); --radius:16px;
      --input-bg:#ffffff; --input-text:#111827; --input-border:#d1d5db;
    }
    :root[data-theme="dark"]{
      --bg:#0b0b0c; --card:#141416; --text:#f3f4f6; --muted:#a1a1aa; --line:#26282c;
      --accent:#66e3ff; --danger:#ff6b6b; --warn:#ffb020; --ok:#34d399;
      --shadow: 0 12px 34px rgba(0,0,0,.28);
      --input-bg:#0f1012; --input-text:#f3f4f6; --input-border:#2b2f36;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:10; background: color-mix(in oklab, var(--bg) 92%, transparent); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); padding:14px; }
    .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:16px; letter-spacing:.02em; }
    .pill{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted);
      background: color-mix(in oklab, var(--card) 86%, transparent); display:inline-flex; gap:8px; align-items:center; white-space:nowrap; }
    .themeBtn{ padding:8px 10px; border-radius:999px; font-size:13px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 88%, var(--bg)); color:var(--text); cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    nav{ display:flex; gap:8px; margin-top:10px; }
    .tab{ flex:1; border:1px solid var(--line); background:transparent; border-radius:999px; padding:10px 8px; font-size:13px; color:var(--muted); cursor:pointer; }
    .tab.active{ color:var(--text); border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 6%, transparent); box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 18%, transparent) inset; }
    .tab.disabled{ opacity:.5; cursor:not-allowed; }

    main{ padding:14px; max-width:1150px; margin:0 auto; }
    .grid{ display:grid; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--input-text); font-size:14px; outline:none; }
    button{ border:1px solid var(--line); background: color-mix(in oklab, var(--card) 88%, var(--bg)); color:var(--text); padding:10px 12px; border-radius:12px; font-size:14px; cursor:pointer; }
    button.primary{ border-color: color-mix(in oklab, var(--accent) 60%, var(--line)); background: color-mix(in oklab, var(--accent) 10%, var(--card)); }
    button.danger{ border-color: color-mix(in oklab, var(--danger) 65%, var(--line)); background: color-mix(in oklab, var(--danger) 10%, var(--card)); }
    button.warn{ border-color: color-mix(in oklab, var(--warn) 65%, var(--line)); background: color-mix(in oklab, var(--warn) 10%, var(--card)); }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }
    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    .stepNo{ display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:999px; border:2px solid var(--danger);
      color:var(--danger); font-weight:900; font-size:16px; line-height:1; flex:0 0 auto; transform: translateY(2px); }
    @media (min-width: 900px) and (orientation: landscape){ .stepNo{ width:36px; height:36px; font-size:19px; border-width:2.5px; } }

    .manualBar{ margin-top:10px; border:1px solid var(--line); border-radius:14px; padding:10px 12px;
      background: color-mix(in oklab, var(--card) 88%, var(--bg)); display:grid; gap:6px; }
    .manualLine{ font-size:12px; color:var(--muted); line-height:1.5; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .manualChip{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text); display:inline-flex; gap:8px; align-items:center; white-space:nowrap; font-size:12px; }

    .kpiGrid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .kpi{ border:1px solid var(--line); border-radius:14px; padding:10px 12px; background: color-mix(in oklab, var(--card) 92%, var(--bg)); }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; margin-top:4px; }

    .locked{ opacity:.55; filter:saturate(.85); pointer-events:none; }
    .lockNote{ border:1px solid color-mix(in oklab, var(--warn) 40%, var(--line)); background: color-mix(in oklab, var(--warn) 8%, var(--card));
      border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:flex-start; }

    .stageWrap{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .seg{ display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; background: color-mix(in oklab, var(--card) 90%, var(--bg)); }
    .seg button{ border:none; border-right:1px solid var(--line); border-radius:0; padding:10px 14px; font-size:13px; background:transparent; color:var(--muted); cursor:pointer; }
    .seg button:last-child{ border-right:none; }
    .seg button.active{ color:var(--text); background: color-mix(in oklab, var(--accent) 10%, var(--card)); }
    .dot{ width:10px; height:10px; border-radius:50%; background: color-mix(in oklab, var(--warn) 70%, transparent); display:inline-block; }
    .dot.ok{ background: color-mix(in oklab, var(--ok) 70%, transparent); }
    .dot.run{ background: color-mix(in oklab, var(--accent) 70%, transparent); }

    .list{ display:grid; gap:10px; }
    .item{ border:1px solid var(--line); background: color-mix(in oklab, var(--card) 92%, var(--bg)); border-radius:14px; padding:12px; }
    .itemHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .itemHeader h3{ margin:0; font-size:14px; }

    .badge{ font-size:11px; color:var(--muted); padding:4px 8px; border:1px solid var(--line); border-radius:999px; white-space:nowrap;
      background: color-mix(in oklab, var(--card) 80%, transparent); display:inline-flex; gap:6px; align-items:center; }
    .badge.warn{ color: color-mix(in oklab, var(--warn) 80%, var(--text)); border-color: color-mix(in oklab, var(--warn) 45%, var(--line));
      background: color-mix(in oklab, var(--warn) 8%, var(--card)); }

    .prodRow{ display:grid; grid-template-columns: 1fr 560px; gap:10px; align-items:center; padding:12px 0;
      border-top:1px dashed color-mix(in oklab, var(--text) 12%, transparent); }
    .prodRow:first-child{ border-top:none; padding-top:0; }

    .prodName{ font-size:16px; font-weight:800; text-align:center; letter-spacing:.02em; }
    .prodMeta{ font-size:12px; color:var(--muted); margin-top:6px; text-align:center; }

    .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; align-items:stretch; }
    .ctrlBox{ border:1px solid var(--line); border-radius:14px; padding:10px; background: color-mix(in oklab, var(--card) 92%, var(--bg)); }
    .ctrlBox.startBox{ background: color-mix(in oklab, #ef4444 7%, var(--card)); border-color: color-mix(in oklab, #ef4444 22%, var(--line)); }
    .ctrlBox.endBox{ background: color-mix(in oklab, #3b82f6 7%, var(--card)); border-color: color-mix(in oklab, #3b82f6 22%, var(--line)); }
    .ctrlBox.readonly{ opacity:.92; filter:saturate(.9); }
    .ctrlTitle{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); margin-bottom:10px; }
    .ctrlGrid{ display:grid; grid-template-columns: 48px 62px 1fr 62px 48px; gap:8px; align-items:center; }
    .stepBtn{ height:50px; display:flex; align-items:center; justify-content:center; border-radius:12px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, var(--bg)); user-select:none; cursor:pointer; font-size:14px; font-weight:700; }
    .startBox .stepBtn.primary{ border-color: color-mix(in oklab, #ef4444 45%, var(--line)); background: color-mix(in oklab, #ef4444 10%, var(--card)); }
    .endBox .stepBtn.primary{ border-color: color-mix(in oklab, #3b82f6 45%, var(--line)); background: color-mix(in oklab, #3b82f6 10%, var(--card)); }

    .qtyInput{ height:50px; text-align:center; font-size:18px; padding:12px 10px; border-radius:12px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 78%, var(--bg)); }
    .roQty{ height:50px; border-radius:12px; border:1px solid var(--line); background: color-mix(in oklab, var(--card) 78%, var(--bg));
      display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; }

    .usedBox{ border:1px solid var(--line); border-radius:14px; padding:12px; background: color-mix(in oklab, var(--card) 92%, var(--bg));
      display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:flex-end; min-height:100%; }
    .usedLine{ font-size:12px; color:var(--muted); }
    .usedVal{ font-size:18px; font-weight:900; }
    .usedVal.negative{ color:var(--danger); }
    .usedVal.missing{ color:var(--warn); }

    @media (max-width: 980px){
      .prodRow{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      .usedBox{ align-items:flex-start; }
    }
    @media (min-width: 900px) and (max-width: 1100px) and (orientation: landscape){
      main{ max-width:1024px; padding:12px; }
      .prodRow{ grid-template-columns: 360px 1fr; gap:12px; }
      .controls{ grid-template-columns: 1fr 1fr; grid-template-areas:"start end" "used used"; gap:12px; }
      .startArea{ grid-area:start; } .endArea{ grid-area:end; } .usedArea{ grid-area:used; }
      .usedBox{ align-items:flex-start; }
      .stepBtn{ height:54px; } .qtyInput{ height:54px; font-size:19px; } .roQty{ height:54px; font-size:19px; }
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <h1>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰ - Sample J</h1>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <button id="btnTheme" class="themeBtn" type="button">â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span></button>
      <div class="pill"><span id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</span> <span class="mono" id="deviceId">â€”</span></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="banquet" id="tabBtnBanquet">å®´ä¼š</button>
    <button class="tab" data-tab="master" id="tabBtnMaster">å•†å“ãƒã‚¹ã‚¿</button>
    <button class="tab" data-tab="sync" id="tabBtnSync">åŒæœŸ/ãƒ­ã‚°</button>
  </nav>

  <div class="manualBar">
    <div class="manualLine">
      <span class="manualChip"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³</span>
      <span class="manualChip"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰</span>
      <span class="manualChip"><span class="stepNo">3</span>å®´ä¼šæƒ…å ±å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">4</span>å•†å“å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰</span>
      <span class="manualChip"><span class="stepNo">5</span>é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰</span>
      <span class="manualChip"><span class="stepNo">6</span>é–‹å§‹ç¢ºå®š</span>
      <span class="manualChip"><span class="stepNo">7</span>çµ‚äº†å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">8</span>å®´ä¼šä¿å­˜</span>
    </div>
    <div class="manualLine">
      <span class="manualChip">â‘¡å®Œäº†å¾Œã¯â‘¢ã¸è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span>
      <span class="manualChip">â‘¤ã¯èª¤ã‚¿ãƒƒãƒ—/å†èª­ã¿è¾¼ã¿å¯¾ç­–ï¼ˆå¾©å…ƒï¼‰</span>
    </div>
  </div>
</header>

<main>
  <section id="tab-banquet" class="grid">

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåº—èˆ—å…±é€šï¼‰</h2>
      <div class="row">
        <div>
          <label>åº—èˆ—å…±é€šãƒ¡ãƒ¼ãƒ«</label>
          <input id="email" type="email" placeholder="ä¾‹ï¼šstore@example.com" />
        </div>
        <div>
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input id="pw" type="password" placeholder="********" />
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnLogin" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="ghost" id="btnLogout" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="small">â€»åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹è¤‡æ•°iPadé–“ã§ã€ãƒã‚¹ã‚¿/å®´ä¼šä¸‹æ›¸ããŒè‡ªå‹•åŒæœŸã—ã¾ã™ï¼ˆRealtimeï¼‰ã€‚</div>
    </div>

    <div class="card" id="reloadCard" style="display:none;">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰</h2>
      <div class="lockNote">
        <div style="flex:0 0 auto;">âš ï¸</div>
        <div>
          <div style="font-weight:900; margin-bottom:4px;">ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã¯å¿…ãšã€Œå†èª­ã¿è¾¼ã¿ã€ã—ã¦ãã ã•ã„ï¼ˆæŠ¼ã—å¿˜ã‚Œé˜²æ­¢ï¼‰ã€‚</div>
          <div class="small">å®Œäº†ã™ã‚‹ã¾ã§ã€â‘¢ä»¥é™ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnReloadNow" type="button"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹</button>
        <button class="ghost" id="btnReloadRetry" type="button">å†è©¦è¡Œ</button>
      </div>
      <div id="reloadMsg" class="small mono" style="margin-top:8px;">â€”</div>
    </div>

    <div id="appArea" class="grid locked">

      <div class="card" id="metaCard">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <h2 style="margin:0; font-size:15px;"><span class="stepNo">3</span>å®´ä¼š æƒ…å ±</h2>
          <div class="btnbar" style="margin-top:0;">
            <button class="ghost" id="btnMetaReset" type="button">â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
            <button class="ghost" id="btnUnlockMeta" type="button" style="display:none;">â‘¢ã‚’ç·¨é›†ã«æˆ»ã™ï¼ˆâ‘¥å–ã‚Šæ¶ˆã—ï¼‰</button>
          </div>
        </div>
        <div class="small" id="metaLockHint" style="margin-top:6px;">â€”</div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>æ—¥ä»˜</label>
            <input id="evDate" type="date" />
          </div>
          <div>
            <label>äººæ•°</label>
            <input id="evGuests" inputmode="numeric" placeholder="ä¾‹ï¼š30" />
          </div>
          <div>
            <label>é£²ã¿æ”¾é¡Œå˜ä¾¡ï¼ˆå††/äººï¼‰</label>
            <input id="evDrinkPrice" inputmode="numeric" placeholder="ä¾‹ï¼š3000" />
            <div class="small">è¦‹è¾¼ã¿å£²ä¸Šï¼äººæ•°Ã—å˜ä¾¡</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é£²ã¿æ”¾é¡Œï¼ˆåŸºæœ¬90åˆ† + å»¶é•·30åˆ†å˜ä½ï¼‰</label>
            <div class="row" style="margin:0;">
              <div style="min-width:220px; flex:1;">
                <input id="evExt" inputmode="numeric" placeholder="å»¶é•·å›æ•°ï¼ˆ0ã€œï¼‰ä¾‹ï¼š1" />
                <div class="small">å»¶é•·å›æ•° Ã— 30åˆ†</div>
              </div>
              <div class="kpi" style="flex:1;">
                <div class="t">åˆè¨ˆæ™‚é–“</div>
                <div class="v mono" id="evDuration">90åˆ†</div>
              </div>
            </div>
          </div>

          <div>
            <label>ç€å¸­ / ç«‹é£Ÿ</label>
            <select id="evStyle">
              <option value="seated">ç€å¸­</option>
              <option value="standing">ç«‹é£Ÿ</option>
            </select>
          </div>

          <div>
            <label>ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ‹…å½“è€…ï¼ˆ1ã€œ2åã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="evStaff" placeholder="ä¾‹ï¼šå±±ç”°, ä½è—¤" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ï¼ˆçµ‚äº†å…¥åŠ›åˆ†ã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiThisCost">Â¥0</div>
            <div class="small" id="kpiMissingEnds">æœªå…¥åŠ› 0</div>
          </div>
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿å£²ä¸Šï¼ˆäººæ•°Ã—å˜ä¾¡ï¼‰</div>
            <div class="v mono" id="kpiThisSales">â€”</div>
            <div class="small" id="kpiSalesHint">äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—</div>
          </div>
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ç‡ï¼ˆåŸä¾¡Ã·å£²ä¸Šï¼‰</div>
            <div class="v mono" id="kpiThisCostRate">â€”</div>
            <div class="small" id="kpiThisStatus">çŠ¶æ…‹ï¼šæœªç¢ºå®š</div>
          </div>
          <div class="kpi">
            <div class="t">å•†å“ç‚¹æ•°ï¼ˆä½¿ç”¨æ•°&gt;0ï¼‰</div>
            <div class="v mono" id="kpiThisItems">0</div>
            <div class="small">ä½¿ç”¨æ•°ï¼é–‹å§‹âˆ’çµ‚äº†</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="stageWrap">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="dot" id="draftDot"></span>
            <div>
              <div style="font-size:14px; font-weight:900;">é€²è¡Œï¼š<span id="stageLabel">â‘£é–‹å§‹å…¥åŠ›</span></div>
              <div class="small mono" id="draftInfo">ä¸‹æ›¸ãï¼šæœªä¿å­˜</div>
            </div>
          </div>

          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="seg">
              <button id="btnStageStart" class="active" type="button"><span class="stepNo">4</span>é–‹å§‹å…¥åŠ›</button>
              <button id="btnStageEnd" type="button"><span class="stepNo">7</span>çµ‚äº†å…¥åŠ›</button>
            </div>
            <button class="primary" id="btnDraftSave" type="button"><span class="stepNo">5</span>é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
            <button class="danger" id="btnDraftClear" type="button">ä¸‹æ›¸ãã‚’å‰Šé™¤</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnbar" style="margin-top:0;">
          <button class="primary" id="btnConfirmStart" type="button">
            <span class="stepNo">6</span>é–‹å§‹ã‚’ç¢ºå®šï¼ˆåŒæœŸã—ã¦ä¿å­˜ï¼‰â†’ <span class="stepNo">7</span>çµ‚äº†å…¥åŠ›ã¸
          </button>
          <button class="ghost" id="btnBackToStart" type="button" style="display:none;">
            é–‹å§‹ã‚’ç·¨é›†ã—ç›´ã™ï¼ˆçµ‚äº†å…¥åŠ›ã‚’ç ´æ£„ï¼‰
          </button>
          <button class="primary" id="btnFinishEvent" type="button" style="display:none;">
            <span class="stepNo">8</span>å®´ä¼šã‚’å®Œäº†ã—ã¦ä¿å­˜ï¼ˆeventã«ç¢ºå®šï¼‰
          </button>
        </div>

        <div class="small" style="margin-top:8px;">
          âœ… â‘¤ã¯ã€Œå¾©å…ƒã€ç”¨ï¼ˆãƒŸã‚¹ã‚¿ãƒƒãƒ—/å†èª­ã¿è¾¼ã¿ã§ã‚‚æ¶ˆãˆãªã„ï¼‰<br>
          âœ… â‘¥é–‹å§‹ç¢ºå®šå¾Œã¯ã€â‘¢ã¨é–‹å§‹ãŒãƒ­ãƒƒã‚¯ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
        </div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0 0 6px; font-size:15px;"><span class="stepNo">4</span>å•†å“å…¥åŠ›ï¼ˆé–‹å§‹ / çµ‚äº†ï¼‰</h2>
            <div class="small" id="productsHint">é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¥é–‹å§‹ç¢ºå®š</div>
          </div>
          <div class="btnbar" style="margin-top:0;">
            <button class="primary" id="btnAutofillMin" type="button">ç›®å®‰ã¾ã§ä¸€æ‹¬å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰</button>
          </div>
        </div>

        <div class="hr"></div>
        <div id="products" class="list"></div>
        <div id="noProducts" class="small">å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚ã€Œå•†å“ãƒã‚¹ã‚¿ã€ã‚¿ãƒ–ã§å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;">å®´ä¼šä¸€è¦§ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰ï¼‹ç´¯è¨ˆ</h2>

        <div class="row">
          <div>
            <label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé–‹å§‹æ—¥ï¼‰</label>
            <input id="fFrom" type="date" />
          </div>
          <div>
            <label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆçµ‚äº†æ—¥ï¼‰</label>
            <input id="fTo" type="date" />
          </div>
          <div>
            <label>æ“ä½œ</label>
            <div class="btnbar" style="margin-top:0;">
              <button class="ghost" id="btnClearFilter" type="button">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
            </div>
          </div>
        </div>

        <div class="kpiGrid" style="margin-top:10px;">
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿åŸä¾¡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumCostComplete">Â¥0</div>
            <div class="small">æœªå…¥åŠ›ãŒç„¡ã„å®´ä¼šã®ã¿</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿å£²ä¸Šï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumSalesComplete">Â¥0</div>
            <div class="small">äººæ•°Ã—å˜ä¾¡ï¼ˆæœªå…¥åŠ›ã¯é™¤å¤–ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ åŸä¾¡ç‡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumCostRateComplete">â€”</div>
            <div class="small">åŸä¾¡Ã·å£²ä¸Š</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ äººæ•° / å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰</div>
            <div class="v mono" id="kpiSumGuests">0</div>
            <div class="small mono" id="kpiAvgPerHead">â€”</div>
          </div>
        </div>

        <div class="hr"></div>
        <div id="events" class="list"></div>
        <div id="noEvents" class="small">ã¾ã å®´ä¼šãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>

    </div>
  </section>

  <section id="tab-master" class="grid" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">å•†å“ãƒã‚¹ã‚¿ï¼ˆç«¯æœ«é–“åŒæœŸï¼‰</h2>

      <div class="row">
        <div>
          <label>å•†å“å</label>
          <input id="mName" placeholder="ä¾‹ï¼šç”Ÿãƒ“ãƒ¼ãƒ« / ãƒã‚¤ãƒœãƒ¼ãƒ« / ãƒ¯ã‚¤ãƒ³èµ¤" />
        </div>
        <div>
          <label>å˜ä½ï¼ˆä¾‹ï¼šæœ¬/æ¨½/ç¼¶ï¼‰</label>
          <input id="mUnit" placeholder="ä¾‹ï¼šæœ¬" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ä»•å…¥å˜ä¾¡ï¼ˆå††/1å˜ä½ï¼‰</label>
          <input id="mCost" inputmode="numeric" placeholder="ä¾‹ï¼š4800" />
        </div>
        <div>
          <label>æœ€ä½ç”¨æ„æ•°ï¼ˆæœ¬ï¼‰</label>
          <input id="mMin" inputmode="decimal" placeholder="ä¾‹ï¼š6ï¼ˆ0.1åˆ»ã¿OKï¼‰" />
          <div class="small">â‘£ã®ã€Œç›®å®‰ã¾ã§ä¸€æ‹¬å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰ã€ã«ä½¿ã„ã¾ã™ã€‚</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label>
          <input id="mCat" placeholder="ä¾‹ï¼šBEER / WHISKY / WINE / SOFT" />
        </div>
        <div>
          <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
          <input id="mNote" placeholder="ä¾‹ï¼š20Læ¨½ / 700mlãƒœãƒˆãƒ«" />
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnAddMaster" type="button">ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
        <button class="primary" id="btnSaveMaster" type="button">ãƒã‚¹ã‚¿ã‚’ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
      </div>
      <div class="small">â€»ãƒã‚¹ã‚¿ã¯ä¿å­˜ï¼ˆåŒæœŸï¼‰ã™ã‚‹ã¾ã§ä»–ç«¯æœ«ã«åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">ç™»éŒ²æ¸ˆã¿ãƒã‚¹ã‚¿</h2>
      <div id="masterList" class="list"></div>
      <div id="noMaster" class="small">ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚</div>
    </div>
  </section>

  <section id="tab-sync" class="grid" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">åŒæœŸ/ãƒ­ã‚°</h2>
      <div class="row">
        <div class="pill">Realtime: <b id="rtState">â€”</b></div>
        <div class="pill">master updated_at: <b id="masterUpdated">â€”</b></div>
        <div class="pill">events loaded: <b id="eventsCount">0</b></div>
      </div>
      <div class="btnbar">
        <button class="ghost" id="btnDump" type="button">ç¾åœ¨ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºã™</button>
      </div>
      <div class="hr"></div>
      <div class="small">ãƒ­ã‚°</div>
      <pre id="log" class="mono" style="white-space:pre-wrap; background:var(--input-bg); border:1px solid var(--line); padding:12px; border-radius:14px; margin:0;">-</pre>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
(() => {
  // =======================
  // â˜…å›ºå®šï¼šã‚ãªãŸæŒ‡å®šã®URL/ANONï¼ˆåŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰
  // =======================
  const SUPABASE_URL = "https://pftjjrluhdbovoaxnykn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdGpqcmx1aGRib3ZvYXhueWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzUzMTUsImV4cCI6MjA4NjcxMTMxNX0.qX-LpvYcbu589h96FdxJmUEqYto64wniBcuGXraJaoU";
  // =======================

  const DRAFT_KIND = "event_draft";
  const DRAFT_KEY  = "active";
  const LOCAL_DRAFT_KEY = "banquet_draft_v2";
  const THEME_KEY = "banquet_theme";
  const DID_KEY = "banquet_device_id";

  // ä¿å­˜é »åº¦ï¼ˆè»½é‡åŒ–ï¼‰
  const LOCAL_SAVE_DEBOUNCE_MS = 1200;     // localStorageã¯å°‘ã—é…ã‚ï¼ˆå¾©å…ƒç›®çš„ï¼‰
  const REMOTE_SAVE_MIN_INTERVAL_MS = 2000; // supabase upsertã¯é–“å¼•ãï¼ˆ2ç§’é–“éš”ï¼‰
  const REMOTE_SAVE_DEBOUNCE_MS = 700;     // è§¦ã‚Šç¶šã‘ãŸæ™‚ã«ã¾ã¨ã‚ã‚‹

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id) => document.getElementById(id);

  const CSS_ESC = (window.CSS && CSS.escape) ? CSS.escape : (s)=>String(s).replace(/[^\w-]/g, "\\$&");

  // -----------------------
  // Theme (default light)
  // -----------------------
  function applyTheme(theme){
    document.documentElement.dataset.theme = theme;
    document.documentElement.style.colorScheme = theme; // iOSãƒ•ã‚©ãƒ¼ãƒ æš—è»¢å¯¾ç­–
    const btn = $("btnTheme");
    btn.innerHTML = theme === "dark"
      ? `ğŸŒ™ <span class="mono" style="font-size:12px;">DARK</span>`
      : `â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span>`;
    localStorage.setItem(THEME_KEY, theme);
  }
  applyTheme(localStorage.getItem(THEME_KEY) || "light");
  $("btnTheme").addEventListener("click", () => {
    const now = document.documentElement.dataset.theme || "light";
    applyTheme(now === "dark" ? "light" : "dark");
  });

  // -----------------------
  // Device id
  // -----------------------
  function getOrCreateDeviceId(){
    let did = localStorage.getItem(DID_KEY);
    if(!did){
      did = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      localStorage.setItem(DID_KEY, did);
    }
    return did;
  }
  $("deviceId").textContent = getOrCreateDeviceId();

  // -----------------------
  // Tabs
  // -----------------------
  function showTab(tab){
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x => { if(x.dataset.tab === tab) x.classList.add("active"); });
    ["banquet","master","sync"].forEach(k => { $("tab-"+k).style.display = (k === tab) ? "" : "none"; });
    if(tab === "master") renderMaster();
    if(tab === "banquet"){ /* no-op */ }
  }
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => { if(btn.classList.contains("disabled")) return; showTab(btn.dataset.tab); });
  });

  // -----------------------
  // Utils
  // -----------------------
  function log(msg, obj){
    const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : "");
    $("log").textContent = line + "\n\n" + $("log").textContent;
  }
  function todayISO(){
    const d = new Date();
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  function yen(n){ const v = Math.round((n || 0)); return "Â¥" + v.toLocaleString("ja-JP"); }
  function pct(n){ if(!Number.isFinite(n)) return "â€”"; return (n*100).toFixed(1) + "%"; }
  function parseIntSafe(v){ const s = String(v ?? "").replace(/,/g,"").trim(); if(!s) return null; const n = Number(s); return Number.isFinite(n) ? Math.trunc(n) : null; }
  function parseNumberSafe(v){ const s = String(v ?? "").replace(/,/g,"").trim(); if(s === "") return null; const n = Number(s); return Number.isFinite(n) ? n : null; }
  function to10(x){ return Math.round(Number(x||0) * 10); }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function scrollToMetaCard(){ const el = $("metaCard"); if(el) el.scrollIntoView({ behavior:"smooth", block:"start" }); }

  // -----------------------
  // â‘¡å†èª­ã¿è¾¼ã¿ãƒ­ãƒƒã‚¯
  // -----------------------
  let mustReload = true;
  function setMustReload(on){
    mustReload = !!on;
    $("reloadCard").style.display = mustReload ? "" : "none";
    $("appArea").classList.toggle("locked", mustReload);
    $("tabBtnMaster").classList.toggle("disabled", mustReload);
    $("tabBtnSync").classList.toggle("disabled", mustReload);
  }
  function setReloadMsg(t){ $("reloadMsg").textContent = t || "â€”"; }
  function setReloadBusy(b, t){
    $("btnReloadNow").disabled = !!b;
    $("btnReloadRetry").disabled = !!b;
    setReloadMsg(t || (b ? "å†èª­ã¿è¾¼ã¿ä¸­â€¦" : "â€”"));
  }

  // -----------------------
  // App state
  // -----------------------
  let master = { version:1, items:[], lastSavedAt:null, lastSavedBy:null };
  let masterRowUpdatedAt = null;

  // âœ… Map cacheï¼ˆfindå»ƒæ­¢ï¼‰
  let itemsById = new Map();
  let min10ById = new Map();
  let costYenById = new Map();

  let events = [];             // docs rows
  let eventsByKey = new Map(); // doc_key -> row

  // Draft
  let stage = "start"; // start/end
  let start10 = {};
  let end10 = {};

  // âœ… é›†è¨ˆã‚’å¢—åˆ†æ›´æ–°
  let itemStatsById = new Map(); // itemId -> {lineCost, usedPos, missing, negative}
  let agg = { total:0, usedItemCount:0, missingEnds:0, negativeCount:0 };

  // Draft bookkeeping
  let draftSavedAt = null;
  let draftSavedBy = null;
  let draftServerUpdatedAt = null;
  let draftDirty = false;

  // Save schedulers
  let localSaveTimer = null;
  let remoteSaveTimer = null;
  let remoteLastSentAt = 0;
  let remoteInFlight = false;
  let pendingRemote = false;

  // DOM caches for product rowsï¼ˆå·®åˆ†æ›´æ–°ï¼‰
  let productRowElById = new Map();
  let productsBuiltForStage = null;

  // Realtime
  let rtChannel = null;

  // -----------------------
  // Auth
  // -----------------------
  async function getUser(){
    const { data, error } = await sb.auth.getUser();
    if(error) log("auth.getUser error", error);
    return data?.user || null;
  }
  async function refreshAuthState(){
    const u = await getUser();
    $("authState").textContent = u ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${u.email || "(no email)"}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return u;
  }

  // -----------------------
  // Cache rebuild
  // -----------------------
  function rebuildItemCaches(){
    itemsById = new Map();
    min10ById = new Map();
    costYenById = new Map();
    (master.items||[]).forEach(it => {
      itemsById.set(it.id, it);
      costYenById.set(it.id, Number(it.costYen||0));
      const minQty = (it.minQty===null || it.minQty===undefined) ? null : Number(it.minQty);
      const min10 = (minQty!==null && Number.isFinite(minQty) && minQty>0) ? to10(minQty) : null;
      min10ById.set(it.id, min10);
    });
  }

  // -----------------------
  // Master row ensure/load/save
  // -----------------------
  async function ensureMasterRow(){
    const u = await getUser();
    if(!u) throw new Error("not logged in");

    const { data, error } = await sb
      .from("docs")
      .select("payload, updated_at")
      .eq("kind","master")
      .eq("doc_key","main")
      .maybeSingle();

    if(error) throw error;

    if(!data){
      const seed = { version:1, items:[], lastSavedAt:null, lastSavedBy:getOrCreateDeviceId() };
      const ins = await sb
        .from("docs")
        .insert({ user_id:u.id, kind:"master", doc_key:"main", payload:seed })
        .select("payload, updated_at")
        .single();
      if(ins.error) throw ins.error;
      return ins.data;
    }
    return data;
  }

  function initQtyMaps(){
    const s = {};
    const e = {};
    (master.items || []).forEach(it => {
      s[it.id] = (start10[it.id] ?? 0);
      e[it.id] = (end10[it.id] === undefined) ? null : end10[it.id];
    });
    start10 = { ...s };
    end10 = { ...e };
  }

  async function loadMaster(){
    const u = await getUser();
    if(!u) return;

    const row = await ensureMasterRow();
    master = row.payload || { version:1, items:[] };
    masterRowUpdatedAt = row.updated_at || null;
    $("masterUpdated").textContent = masterRowUpdatedAt || "â€”";

    rebuildItemCaches();
    initQtyMaps();

    // âœ… å•†å“DOMã¯ stageä¾å­˜ã€‚å¿…è¦ãªã‚‰å…¨å†æ§‹ç¯‰
    buildProductsListIfNeeded(true);

    recomputeAggAll();
    updateDurationUI();
    updateStageUI();
    updateAllKpis();
    renderMaster();
  }

  async function saveMaster(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    master.lastSavedAt = new Date().toISOString();
    master.lastSavedBy = getOrCreateDeviceId();

    const { data, error } = await sb
      .from("docs")
      .upsert(
        { user_id:u.id, kind:"master", doc_key:"main", payload:master },
        { onConflict:"user_id,kind,doc_key" }
      )
      .select("updated_at")
      .single();

    if(error){
      log("saveMaster error", error);
      return alert("ãƒã‚¹ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
    masterRowUpdatedAt = data?.updated_at || null;
    $("masterUpdated").textContent = masterRowUpdatedAt || "â€”";

    rebuildItemCaches();
    initQtyMaps();
    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateAllKpis();

    markDraftDirty("master saved");
    alert("ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¦åŒæœŸã—ã¾ã—ãŸ");
  }

  // -----------------------
  // Draft meta + sales
  // -----------------------
  function updateDurationUI(){
    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    $("evDuration").textContent = `${90 + 30*ext}åˆ†`;
  }
  function getDraftSalesYen(){
    const guests = parseIntSafe($("evGuests").value);
    const per = parseIntSafe($("evDrinkPrice").value);
    if(!guests || guests<=0) return null;
    if(!per || per<=0) return null;
    return guests*per;
  }

  // -----------------------
  // âœ… å¢—åˆ†é›†è¨ˆ
  // -----------------------
  function computeItemStats(itemId){
    const costYen = costYenById.get(itemId) || 0;
    const s10 = start10[itemId] || 0;
    const e10 = end10[itemId];

    const missing = (s10>0 && (e10===null || e10===undefined));
    if(e10===null || e10===undefined){
      return { lineCost:0, usedPos:false, missing, negative:false };
    }

    const used10 = s10 - e10;
    const negative = used10 < 0;
    const used = used10 / 10;
    const usedPos = used > 0;
    const lineCost = usedPos ? Math.round(used * costYen) : 0;
    return { lineCost, usedPos, missing, negative };
  }

  function recomputeAggAll(){
    itemStatsById = new Map();
    agg = { total:0, usedItemCount:0, missingEnds:0, negativeCount:0 };

    for(const it of (master.items||[])){
      const st = computeItemStats(it.id);
      itemStatsById.set(it.id, st);
      agg.total += st.lineCost;
      agg.usedItemCount += st.usedPos ? 1 : 0;
      agg.missingEnds += st.missing ? 1 : 0;
      agg.negativeCount += st.negative ? 1 : 0;
    }
  }

  function updateAggForItem(itemId){
    const prev = itemStatsById.get(itemId) || { lineCost:0, usedPos:false, missing:false, negative:false };
    const next = computeItemStats(itemId);

    agg.total += (next.lineCost - prev.lineCost);
    agg.usedItemCount += (next.usedPos ? 1 : 0) - (prev.usedPos ? 1 : 0);
    agg.missingEnds += (next.missing ? 1 : 0) - (prev.missing ? 1 : 0);
    agg.negativeCount += (next.negative ? 1 : 0) - (prev.negative ? 1 : 0);

    itemStatsById.set(itemId, next);
  }

  // -----------------------
  // KPIï¼ˆå…¨èµ°æŸ»ã—ãªã„ï¼‰
  // -----------------------
  function updateAllKpis(){
    $("kpiThisCost").textContent = yen(agg.total);
    $("kpiThisItems").textContent = String(agg.usedItemCount);

    const extraNeg = agg.negativeCount ? ` / å¢—åŠ ç–‘ã„ ${agg.negativeCount}` : "";
    $("kpiMissingEnds").textContent = `æœªå…¥åŠ› ${agg.missingEnds}` + extraNeg;

    const sales = getDraftSalesYen();
    if(sales !== null){
      $("kpiThisSales").textContent = yen(sales);
      $("kpiThisCostRate").textContent = pct(agg.total / sales);
      $("kpiSalesHint").textContent = "â€”";
    }else{
      $("kpiThisSales").textContent = "â€”";
      $("kpiThisCostRate").textContent = "â€”";
      $("kpiSalesHint").textContent = "äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—";
    }

    const status = (stage === "start")
      ? "çŠ¶æ…‹ï¼šâ‘£é–‹å§‹å…¥åŠ›ä¸­ï¼ˆâ‘¦çµ‚äº†æœªå…¥åŠ›ï¼‰"
      : (agg.missingEnds===0 ? "çŠ¶æ…‹ï¼šç¢ºå®šï¼ˆâ‘§ä¿å­˜å¯èƒ½ï¼‰" : "çŠ¶æ…‹ï¼šæœªç¢ºå®šï¼ˆçµ‚äº†æœªå…¥åŠ›ã‚ã‚Šï¼‰");
    $("kpiThisStatus").textContent = status;

    updateDraftInfoUI("");
  }

  // -----------------------
  // Draft payloadï¼ˆä¿å­˜æ™‚ã ã‘ç”Ÿæˆï¼‰
  // -----------------------
  function buildDraftPayload(){
    const date = $("evDate").value || todayISO();
    const guests = parseIntSafe($("evGuests").value);
    const drinkPricePerHeadYen = parseIntSafe($("evDrinkPrice").value);
    const salesYen = (guests && drinkPricePerHeadYen) ? guests*drinkPricePerHeadYen : null;

    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    const durationMin = 90 + 30*ext;

    const style = $("evStyle").value;
    const staff = ($("evStaff").value || "").split(",").map(s=>s.trim()).filter(Boolean).slice(0,2);

    const now = new Date().toISOString();
    return {
      version:2,
      stage,
      meta:{ date, guests:guests ?? null, drinkPricePerHeadYen: drinkPricePerHeadYen ?? null, salesYen, extensionCount:ext, durationMin, style, staff },
      start10,
      end10,
      savedAt: now,
      savedBy: getOrCreateDeviceId()
    };
  }

  function applyDraftPayload(p){
    if(!p || typeof p !== "object") return;
    stage = (p.stage === "end") ? "end" : "start";

    const m = p.meta || {};
    $("evDate").value = m.date || todayISO();
    $("evGuests").value = (m.guests ?? "") === null ? "" : String(m.guests ?? "");
    $("evDrinkPrice").value = (m.drinkPricePerHeadYen ?? "") === null ? "" : String(m.drinkPricePerHeadYen ?? "");
    $("evExt").value = String(m.extensionCount ?? 0);
    $("evStyle").value = m.style || "seated";
    $("evStaff").value = (m.staff || []).join(", ");

    start10 = (p.start10 && typeof p.start10 === "object") ? p.start10 : {};
    end10   = (p.end10 && typeof p.end10 === "object") ? p.end10 : {};

    draftSavedAt = p.savedAt || null;
    draftSavedBy = p.savedBy || null;
    draftDirty = false;

    initQtyMaps();
    rebuildItemCaches();

    buildProductsListIfNeeded(true);
    recomputeAggAll();

    updateDurationUI();
    updateStageUI();
    updateAllKpis();
    updateDraftInfoUI("é©ç”¨");
  }

  function saveLocalDraftNow(){
    const payload = buildDraftPayload();
    localStorage.setItem(LOCAL_DRAFT_KEY, JSON.stringify(payload));
  }
  function loadLocalDraft(){
    const raw = localStorage.getItem(LOCAL_DRAFT_KEY);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }
  function clearLocalDraft(){ localStorage.removeItem(LOCAL_DRAFT_KEY); }

  // -----------------------
  // Draft remote (docs)
  // -----------------------
  async function loadRemoteDraft(){
    const u = await getUser();
    if(!u) return null;

    const { data, error } = await sb
      .from("docs")
      .select("payload, updated_at")
      .eq("kind", DRAFT_KIND)
      .eq("doc_key", DRAFT_KEY)
      .maybeSingle();

    if(error){
      log("loadRemoteDraft error", error);
      return null;
    }
    if(!data) return null;

    draftServerUpdatedAt = data.updated_at || null;
    return data.payload || null;
  }

  async function saveRemoteDraftNow(){
    const u = await getUser();
    if(!u) return;

    if(remoteInFlight) { pendingRemote = true; return; }

    const now = Date.now();
    if(now - remoteLastSentAt < REMOTE_SAVE_MIN_INTERVAL_MS){
      pendingRemote = true;
      scheduleRemoteSave();
      return;
    }

    remoteInFlight = true;
    try{
      const payload = buildDraftPayload();
      const { data, error } = await sb
        .from("docs")
        .upsert(
          { user_id:u.id, kind:DRAFT_KIND, doc_key:DRAFT_KEY, payload },
          { onConflict:"user_id,kind,doc_key" }
        )
        .select("updated_at")
        .single();

      if(error) throw error;

      remoteLastSentAt = Date.now();
      draftServerUpdatedAt = data?.updated_at || null;
      draftSavedAt = payload.savedAt;
      draftSavedBy = payload.savedBy;
      draftDirty = false;
      updateDraftInfoUI("åŒæœŸæ¸ˆã¿");

    }catch(e){
      log("saveRemoteDraft failed", e);
      updateDraftInfoUI("åŒæœŸå¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼‰");
    }finally{
      remoteInFlight = false;
      if(pendingRemote){
        pendingRemote = false;
        scheduleRemoteSave();
      }
    }
  }

  async function deleteRemoteDraft(){
    const u = await getUser();
    if(!u) return;
    const { error } = await sb
      .from("docs")
      .delete()
      .eq("kind", DRAFT_KIND)
      .eq("doc_key", DRAFT_KEY);
    if(error) log("deleteRemoteDraft error", error);
  }

  function scheduleRemoteSave(){
    clearTimeout(remoteSaveTimer);
    remoteSaveTimer = setTimeout(() => { saveRemoteDraftNow().catch(()=>{}); }, REMOTE_SAVE_DEBOUNCE_MS);
  }
  function scheduleLocalSave(){
    clearTimeout(localSaveTimer);
    localSaveTimer = setTimeout(() => { try{ saveLocalDraftNow(); }catch{} }, LOCAL_SAVE_DEBOUNCE_MS);
  }

  function markDraftDirty(reason){
    draftDirty = true;
    updateDraftInfoUI(reason ? ("dirty:"+reason) : "dirty");
    scheduleLocalSave();
    scheduleRemoteSave();
  }

  function updateDraftInfoUI(extra){
    const dot = $("draftDot");
    const label = $("draftInfo");

    const saved = draftSavedAt ? `savedAt ${draftSavedAt}` : "æœªä¿å­˜";
    const by = draftSavedBy ? ` / by ${draftSavedBy}` : "";
    const server = draftServerUpdatedAt ? ` / server ${draftServerUpdatedAt}` : "";
    const dirty = draftDirty ? " / *dirty" : "";

    label.textContent = `ä¸‹æ›¸ãï¼š${saved}${by}${server}${dirty}` + (extra ? ` / ${extra}` : "");

    dot.classList.remove("ok","run");
    if(stage === "end") dot.classList.add("run");
    if(!draftDirty && draftSavedAt) dot.classList.add("ok");
  }

  // -----------------------
  // Stage UI + meta lock
  // -----------------------
  function updateStageUI(){
    $("stageLabel").textContent = (stage==="start") ? "â‘£é–‹å§‹å…¥åŠ›" : "â‘¦çµ‚äº†å…¥åŠ›";
    $("btnStageStart").classList.toggle("active", stage==="start");
    $("btnStageEnd").classList.toggle("active", stage==="end");

    $("btnConfirmStart").style.display = (stage==="start") ? "" : "none";
    $("btnBackToStart").style.display = (stage==="end") ? "" : "none";
    $("btnFinishEvent").style.display = (stage==="end") ? "" : "none";

    $("btnAutofillMin").style.display = (stage==="start") ? "" : "none";
    $("productsHint").textContent = (stage==="start")
      ? "é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¥é–‹å§‹ç¢ºå®šï¼ˆâ‘¤åŒæœŸOKï¼‰"
      : "çµ‚äº†ãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã¯å›ºå®šã€‚â‘¦çµ‚äº†å…¥åŠ› â†’ â‘§å®´ä¼šä¿å­˜";

    const lockMeta = (stage==="end");
    ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => { const el = $(id); if(el) el.disabled = lockMeta; });
    $("btnUnlockMeta").style.display = lockMeta ? "" : "none";
    $("btnMetaReset").disabled = lockMeta;

    $("metaLockHint").textContent = lockMeta
      ? "â€»ç¾åœ¨â‘¦çµ‚äº†å…¥åŠ›ä¸­ã®ãŸã‚â‘¢ã¯ãƒ­ãƒƒã‚¯ä¸­ã€‚â‘¢ã‚’ç›´ã™ãªã‚‰ã€Œâ‘¢ã‚’ç·¨é›†ã«æˆ»ã™ï¼ˆâ‘¥å–ã‚Šæ¶ˆã—ï¼‰ã€ã§é–‹å§‹ã¸æˆ»ã—ã¦ã‹ã‚‰ã€‚"
      : "â€»â‘¢â†’â‘£â†’â‘¥ã®æµã‚Œã§é–‹å§‹ç¢ºå®šã€‚â‘¤ã§é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰ã§ãã¾ã™ã€‚";
  }

  // -----------------------
  // âœ… å•†å“DOMï¼šå·®åˆ†æ›´æ–°
  // -----------------------
  function buildProductsListIfNeeded(force){
    const items = master.items || [];
    $("noProducts").style.display = items.length ? "none" : "";

    if(!force && productsBuiltForStage === stage && productRowElById.size === items.length){
      return;
    }

    // å…¨å†æ§‹ç¯‰ï¼ˆstageåˆ‡æ›¿/ãƒã‚¹ã‚¿å¤‰æ›´æ™‚ã®ã¿ï¼‰
    const box = $("products");
    box.innerHTML = "";
    productRowElById = new Map();

    const frag = document.createDocumentFragment();

    for(const it of items){
      if(start10[it.id]===undefined) start10[it.id]=0;
      if(end10[it.id]===undefined) end10[it.id]=null;

      const row = document.createElement("div");
      row.className = "prodRow";
      row.dataset.itemid = it.id;

      row.innerHTML = renderProductRowHTML(it);
      frag.appendChild(row);
      productRowElById.set(it.id, row);
    }

    box.appendChild(frag);
    productsBuiltForStage = stage;

    // ã‚¯ãƒªãƒƒã‚¯/å¤‰æ›´ã¯1ã¤ã®ãƒãƒ³ãƒ‰ãƒ©ã§ã¾ã¨ã‚ã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    box.onclick = onProductsClick;
    box.onchange = onProductsChange;
  }

  function renderProductRowHTML(it){
    const id = it.id;
    const s10 = start10[id] || 0;
    const e10 = end10[id];
    const used10 = (e10===null || e10===undefined) ? null : (s10 - e10);
    const usedText = (used10===null) ? "â€”" : (used10/10).toFixed(1);
    const usedClass = (used10===null) ? "missing" : (used10<0 ? "negative" : "");
    const min10 = min10ById.get(id);

    const shortage = (min10!==null && min10!==undefined && min10>0) ? (s10 < min10) : false;
    const badge = shortage
      ? `<span class="badge warn" data-role="badge">âš  ä¸è¶³</span>`
      : (min10!==null && min10!==undefined && min10>0 ? `<span class="badge" data-role="badge">ç›®å®‰OK</span>` : `<span class="badge" data-role="badge">ç›®å®‰ãªã—</span>`);

    const minText = (min10!==null && min10!==undefined && min10>0)
      ? `${(min10/10).toFixed(1)}${escapeHtml(it.unit||"æœ¬")}`
      : `â€”`;

    const lineCost = (itemStatsById.get(id)?.lineCost ?? computeItemStats(id).lineCost);

    const startBox = (stage==="start")
      ? `
        <div class="ctrlBox startBox startArea">
          <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono" data-role="startDisp">${(s10/10).toFixed(1)}</span></div>
          <div class="ctrlGrid">
            <div class="stepBtn" data-act="step" data-field="start" data-step="-10">âˆ’1</div>
            <div class="stepBtn" data-act="step" data-field="start" data-step="-1">âˆ’0.1</div>
            <input class="qtyInput" data-role="startInput" inputmode="decimal" value="${(s10/10).toFixed(1)}" />
            <div class="stepBtn primary" data-act="step" data-field="start" data-step="1">+0.1</div>
            <div class="stepBtn primary" data-act="step" data-field="start" data-step="10">+1</div>
          </div>
        </div>
      `
      : `
        <div class="ctrlBox startBox startArea readonly">
          <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå›ºå®šï¼‰</span><span class="mono" data-role="startDisp">${(s10/10).toFixed(1)}</span></div>
          <div class="roQty mono" data-role="startRO">${(s10/10).toFixed(1)}</div>
          <div class="small">é–‹å§‹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
        </div>
      `;

    const endBox = (stage==="end")
      ? `
        <div class="ctrlBox endBox endArea">
          <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono" data-role="endDisp">${(e10===null || e10===undefined) ? "â€”" : (e10/10).toFixed(1)}</span></div>
          <div class="ctrlGrid">
            <div class="stepBtn" data-act="step" data-field="end" data-step="-10">âˆ’1</div>
            <div class="stepBtn" data-act="step" data-field="end" data-step="-1">âˆ’0.1</div>
            <input class="qtyInput" data-role="endInput" inputmode="decimal" value="${(e10===null || e10===undefined) ? "" : (e10/10).toFixed(1)}" placeholder="â€”" />
            <div class="stepBtn primary" data-act="step" data-field="end" data-step="1">+0.1</div>
            <div class="stepBtn primary" data-act="step" data-field="end" data-step="10">+1</div>
          </div>
        </div>
      `
      : `
        <div class="ctrlBox endBox endArea readonly">
          <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå¾Œã§ï¼‰</span><span class="mono" data-role="endDisp">â€”</span></div>
          <div class="roQty mono" data-role="endRO">â€”</div>
          <div class="small">â‘¥é–‹å§‹ç¢ºå®šå¾Œã«å…¥åŠ›ã—ã¾ã™</div>
        </div>
      `;

    return `
      <div>
        <div class="prodName">${escapeHtml(it.name)}</div>
        <div class="prodMeta">
          æœ€ä½ç”¨æ„ ${escapeHtml(minText)} / å˜ä¾¡ ${yen(Number(it.costYen||0))} / å˜ä½ ${escapeHtml(it.unit||"æœ¬")}
          &nbsp; ${badge}
        </div>
      </div>

      <div class="controls" data-itemid="${escapeHtml(id)}">
        ${startBox}
        ${endBox}
        <div class="usedBox usedArea">
          <div class="usedLine">ä½¿ç”¨ï¼ˆé–‹å§‹âˆ’çµ‚äº†ï¼‰</div>
          <div class="usedVal ${usedClass} mono" data-role="usedDisp">${usedText}</div>
          <div class="usedLine">åŸä¾¡ï¼š<span class="mono" data-role="costDisp">${yen(lineCost)}</span></div>
        </div>
      </div>
    `;
  }

  function updateProductRow(itemId){
    const row = productRowElById.get(itemId);
    if(!row) return;
    const it = itemsById.get(itemId);
    if(!it) return;

    const s10 = start10[itemId] || 0;
    const e10 = end10[itemId];
    const used10 = (e10===null || e10===undefined) ? null : (s10 - e10);
    const usedText = (used10===null) ? "â€”" : (used10/10).toFixed(1);
    const usedClass = (used10===null) ? "missing" : (used10<0 ? "negative" : "");

    // displays
    const startDisp = row.querySelector('[data-role="startDisp"]');
    if(startDisp) startDisp.textContent = (s10/10).toFixed(1);

    const startInput = row.querySelector('[data-role="startInput"]');
    if(startInput) startInput.value = (s10/10).toFixed(1);

    const startRO = row.querySelector('[data-role="startRO"]');
    if(startRO) startRO.textContent = (s10/10).toFixed(1);

    const endDisp = row.querySelector('[data-role="endDisp"]');
    if(endDisp) endDisp.textContent = (e10===null || e10===undefined) ? "â€”" : (e10/10).toFixed(1);

    const endInput = row.querySelector('[data-role="endInput"]');
    if(endInput && stage==="end"){
      endInput.value = (e10===null || e10===undefined) ? "" : (e10/10).toFixed(1);
    }

    const endRO = row.querySelector('[data-role="endRO"]');
    if(endRO && stage!=="end") endRO.textContent = "â€”";

    const usedDisp = row.querySelector('[data-role="usedDisp"]');
    if(usedDisp){
      usedDisp.textContent = usedText;
      usedDisp.classList.remove("missing","negative");
      if(usedClass) usedDisp.classList.add(usedClass);
    }

    const costDisp = row.querySelector('[data-role="costDisp"]');
    if(costDisp){
      const lineCost = itemStatsById.get(itemId)?.lineCost ?? 0;
      costDisp.textContent = yen(lineCost);
    }

    // badge
    const badgeEl = row.querySelector('[data-role="badge"]');
    const min10 = min10ById.get(itemId);
    const shortage = (min10!==null && min10!==undefined && min10>0) ? (s10 < min10) : false;
    if(badgeEl){
      badgeEl.classList.remove("warn");
      if(shortage){
        badgeEl.classList.add("warn");
        badgeEl.textContent = "âš  ä¸è¶³";
      }else{
        badgeEl.textContent = (min10!==null && min10!==undefined && min10>0) ? "ç›®å®‰OK" : "ç›®å®‰ãªã—";
      }
    }
  }

  function onProductsClick(ev){
    if(mustReload) return;
    const btn = ev.target.closest('[data-act="step"]');
    if(!btn) return;

    const ctrl = btn.closest(".controls");
    if(!ctrl) return;
    const itemId = ctrl.getAttribute("data-itemid");
    const step = parseInt(btn.getAttribute("data-step"),10) || 0;
    const field = btn.getAttribute("data-field");

    if(field==="start"){
      if(stage!=="start") return;
      const prev = start10[itemId] || 0;
      start10[itemId] = Math.max(0, prev + step);
    }else if(field==="end"){
      if(stage!=="end") return;
      const now = (end10[itemId]===null || end10[itemId]===undefined) ? 0 : (end10[itemId]||0);
      end10[itemId] = Math.max(0, now + step);
    }else{
      return;
    }

    // âœ… å¢—åˆ†é›†è¨ˆï¼†è¡Œã ã‘æ›´æ–°
    updateAggForItem(itemId);
    updateProductRow(itemId);
    updateAllKpis();
    markDraftDirty("step");
  }

  function onProductsChange(ev){
    if(mustReload) return;
    const inp = ev.target.closest(".qtyInput");
    if(!inp) return;

    const ctrl = inp.closest(".controls");
    if(!ctrl) return;
    const itemId = ctrl.getAttribute("data-itemid");
    const roleStart = inp.getAttribute("data-role")==="startInput";
    const roleEnd = inp.getAttribute("data-role")==="endInput";

    const val = (inp.value||"").trim();

    if(roleStart){
      if(stage!=="start") return;
      const n = parseNumberSafe(val);
      start10[itemId] = Math.max(0, to10(n||0));
    }else if(roleEnd){
      if(stage!=="end") return;
      if(val===""){
        end10[itemId] = null;
      }else{
        const n = parseNumberSafe(val);
        end10[itemId] = Math.max(0, to10(n||0));
      }
    }else{
      return;
    }

    updateAggForItem(itemId);
    updateProductRow(itemId);
    updateAllKpis();
    markDraftDirty("input");
  }

  // -----------------------
  // Master UI
  // -----------------------
  function renderMaster(){
    const box = $("masterList");
    box.innerHTML = "";
    const items = master.items || [];
    $("noMaster").style.display = items.length ? "none" : "";

    for(const it of items){
      const minQty = (it.minQty===null || it.minQty===undefined) ? null : Number(it.minQty);
      const minText = (minQty!==null && Number.isFinite(minQty) && minQty>0) ? `${minQty.toFixed(1)}${escapeHtml(it.unit||"æœ¬")}` : "â€”";

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${escapeHtml(it.name)}</h3>
            <div class="small">${escapeHtml(it.category||"")}${it.category ? " / " : ""}${escapeHtml(it.note||"")}</div>
            <div class="small">å˜ä½ï¼š${escapeHtml(it.unit||"æœ¬")} / å˜ä¾¡ï¼š<span class="mono">${yen(Number(it.costYen||0))}</span> / æœ€ä½ç”¨æ„ï¼š<span class="mono">${minText}</span></div>
          </div>
          <div><span class="badge">ID: ${escapeHtml(it.id)}</span></div>
        </div>
        <div class="btnbar">
          <button data-act="edit" type="button">ç·¨é›†</button>
          <button class="danger" data-act="del" type="button">å‰Šé™¤</button>
        </div>
      `;

      el.querySelector('[data-act="del"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        if(!confirm(`ã€Œ${it.name}ã€ã‚’ãƒã‚¹ã‚¿ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        master.items = master.items.filter(x => x.id !== it.id);
        delete start10[it.id];
        delete end10[it.id];

        rebuildItemCaches();
        initQtyMaps();
        buildProductsListIfNeeded(true);
        recomputeAggAll();
        updateAllKpis();

        renderMaster();
        markDraftDirty("master del");
      });

      el.querySelector('[data-act="edit"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        const name = prompt("å•†å“å", it.name);
        if(name===null) return;
        const unit = prompt("å˜ä½ï¼ˆä¾‹ï¼šæœ¬/æ¨½/ç¼¶ï¼‰", it.unit || "æœ¬");
        if(unit===null) return;
        const cost = prompt("ä»•å…¥å˜ä¾¡ï¼ˆå††/1å˜ä½ï¼‰", String(it.costYen ?? ""));
        if(cost===null) return;

        const costYen = parseNumberSafe(cost);
        if(costYen===null || costYen<0) return alert("å˜ä¾¡ãŒä¸æ­£ã§ã™");

        const min = prompt("æœ€ä½ç”¨æ„æ•°ï¼ˆæœ¬ï¼‰â€»0.1åˆ»ã¿OKã€ç©ºæ¬„ã§æœªè¨­å®š", (it.minQty ?? "") === null ? "" : String(it.minQty ?? ""));
        if(min===null) return;
        let minQty2 = null;
        if(String(min).trim()!==""){
          const n = parseNumberSafe(min);
          if(n===null || n<0) return alert("æœ€ä½ç”¨æ„æ•°ãŒä¸æ­£ã§ã™");
          minQty2 = Number(n.toFixed(1));
        }

        it.name = name.trim() || it.name;
        it.unit = (unit.trim() || "æœ¬");
        it.costYen = Math.round(costYen);
        it.minQty = minQty2;

        it.category = (prompt("ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰", it.category || "") ?? it.category);
        it.note = (prompt("å‚™è€ƒï¼ˆä»»æ„ï¼‰", it.note || "") ?? it.note);

        rebuildItemCaches();
        buildProductsListIfNeeded(true);
        recomputeAggAll();
        updateAllKpis();

        renderMaster();
        markDraftDirty("master edit");
      });

      box.appendChild(el);
    }
  }

  // -----------------------
  // Events load/render (Realtimeå·®åˆ†æ›´æ–°)
  // -----------------------
  async function loadEvents(){
    const u = await getUser();
    if(!u) return;

    const { data, error } = await sb
      .from("docs")
      .select("doc_key, payload, created_at, updated_at")
      .eq("kind","event")
      .order("created_at",{ ascending:false })
      .limit(400);

    if(error){
      log("loadEvents error", error);
      return;
    }

    events = data || [];
    eventsByKey = new Map();
    for(const r of events) eventsByKey.set(r.doc_key, r);

    $("eventsCount").textContent = String(events.length);
    renderEvents();
  }

  function renderEvents(){
    const box = $("events");
    box.innerHTML = "";

    const from = $("fFrom").value || null;
    const to   = $("fTo").value || null;

    const filtered = (events||[]).filter(e => {
      const d = e.payload?.date;
      if(!d) return true;
      if(from && d < from) return false;
      if(to && d > to) return false;
      return true;
    });

    $("noEvents").style.display = filtered.length ? "none" : "";

    let sumCost=0, sumSales=0, sumGuests=0;

    for(const e of filtered){
      const p = e.payload || {};
      const date = p.date || "-";
      const guests = p.guests ?? null;
      const cost = Number(p.totalCostYen ?? 0);
      const sales = (p.salesYen===null || p.salesYen===undefined) ? null : Number(p.salesYen);
      const missingEnds = Number(p.missingEnds ?? 0);
      const isComplete = !!p.isComplete;

      if(isComplete){
        sumCost += cost;
        if(sales!==null) sumSales += sales;
        if(guests && guests>0) sumGuests += guests;
      }

      const duration = p.durationMin ? `${p.durationMin}åˆ†` : "â€”";
      const style = p.style==="standing" ? "ç«‹é£Ÿ" : "ç€å¸­";
      const staff = (p.staff||[]).join(" / ") || "â€”";
      const perHead = (p.drinkPricePerHeadYen && p.drinkPricePerHeadYen>0) ? yen(p.drinkPricePerHeadYen) : "â€”";
      const rate = (sales && sales>0) ? (cost/sales) : null;

      const badge = isComplete ? `<span class="badge">ç¢ºå®š</span>` : `<span class="badge warn">æœªç¢ºå®šï¼ˆæœªå…¥åŠ›${missingEnds}ï¼‰</span>`;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${escapeHtml(date)}ã€€${guests ? guests+"å" : "äººæ•°â€”"}ã€€${badge}</h3>
            <div class="small">å˜ä¾¡ï¼š<span class="mono">${escapeHtml(perHead)}</span> / æ™‚é–“ï¼š${escapeHtml(duration)} / å½¢æ…‹ï¼š${escapeHtml(style)} / æ‹…å½“ï¼š${escapeHtml(staff)}</div>
            <div class="small">
              å£²ä¸Šï¼š<span class="mono">${sales===null ? "â€”" : yen(sales)}</span>
              / åŸä¾¡ï¼š<span class="mono">${yen(cost)}</span>
              / åŸä¾¡ç‡ï¼š<span class="mono">${rate===null ? "â€”" : pct(rate)}</span>
            </div>
          </div>
          <div><span class="badge">updated: ${escapeHtml(e.updated_at||"-")}</span></div>
        </div>
      `;
      box.appendChild(el);
    }

    $("kpiSumCostComplete").textContent = yen(sumCost);
    $("kpiSumSalesComplete").textContent = yen(sumSales);
    $("kpiSumCostRateComplete").textContent = (sumSales>0) ? pct(sumCost/sumSales) : "â€”";
    $("kpiSumGuests").textContent = String(sumGuests);
    $("kpiAvgPerHead").textContent = (sumGuests>0) ? `å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰ ${yen(sumCost/sumGuests)}` : "â€”";
  }

  // -----------------------
  // Autofill min (start)
  // -----------------------
  function applyMinToAllStarts(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(stage!=="start") return alert("ç›®å®‰ä¸€æ‹¬å…¥åŠ›ã¯ã€Œâ‘£é–‹å§‹å…¥åŠ›ã€ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ãˆã¾ã™ã€‚");
    const items = master.items || [];
    if(!items.length) return alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚");

    const targets = items.filter(it => {
      const min10 = min10ById.get(it.id);
      return (min10!==null && min10!==undefined && min10>0);
    });

    if(!targets.length) return alert("ãƒã‚¹ã‚¿ã®ã€Œæœ€ä½ç”¨æ„æ•°ï¼ˆç›®å®‰ï¼‰ã€ãŒè¨­å®šã•ã‚ŒãŸå•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    if(!confirm(`ãƒã‚¹ã‚¿ã®ç›®å®‰ã¾ã§é–‹å§‹åœ¨åº«ã‚’ä¸€æ‹¬å…¥åŠ›ã—ã¾ã™ã€‚\nå¯¾è±¡ï¼š${targets.length}å“\nï¼ˆå¯¾è±¡å•†å“ã®é–‹å§‹å…¥åŠ›ã¯ä¸Šæ›¸ãï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

    for(const it of targets){
      start10[it.id] = min10ById.get(it.id);
      updateAggForItem(it.id);
      updateProductRow(it.id);
    }

    updateAllKpis();
    markDraftDirty("autofill");
    alert("ç›®å®‰ã¾ã§ä¸€æ‹¬å…¥åŠ›ã—ã¾ã—ãŸï¼ˆé–‹å§‹ï¼‰ã€‚");
  }

  // -----------------------
  // Flow actions
  // -----------------------
  function warnStartBelowMin(){
    const items = master.items || [];
    const shortages = [];
    for(const it of items){
      const min10 = min10ById.get(it.id);
      if(!min10) continue;
      const s = start10[it.id] || 0;
      if(s < min10) shortages.push({ name:it.name, start:(s/10), min:(min10/10) });
    }
    if(!shortages.length) return true;
    const show = shortages.slice(0,8).map(x => `ãƒ»${x.name}ï¼ˆé–‹å§‹${x.start.toFixed(1)} < ç›®å®‰${x.min.toFixed(1)}ï¼‰`).join("\n");
    const more = shortages.length>8 ? `\nâ€¦ä»– ${shortages.length-8} ä»¶` : "";
    return confirm(`ã€è­¦å‘Šã€‘ç›®å®‰ã‚ˆã‚Šé–‹å§‹åœ¨åº«ãŒå°‘ãªã„å“ãŒã‚ã‚Šã¾ã™ã€‚\n\n${show}${more}\n\nãã‚Œã§ã‚‚â‘¥é–‹å§‹ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`);
  }

  function setStageStart(){
    stage = "start";
    for(const it of (master.items||[])) end10[it.id] = null;
    buildProductsListIfNeeded(true); // stageä¾å­˜UIãªã®ã§å…¨å†æ§‹ç¯‰
    recomputeAggAll();
    updateStageUI();
    updateAllKpis();
    markDraftDirty("stage start");
  }

  function setStageEnd(){
    stage = "end";
    for(const it of (master.items||[])) if(end10[it.id]===undefined) end10[it.id] = null;
    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateStageUI();
    updateAllKpis();
    markDraftDirty("stage end");
  }

  async function confirmStart(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(!master.items?.length) return alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    if(!$("evDate").value) $("evDate").value = todayISO();
    if(!warnStartBelowMin()) return;
    setStageEnd();
    alert("â‘¥é–‹å§‹ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚æ¬¡ã¯â‘¦çµ‚äº†å…¥åŠ›ã§ã™ã€‚");
  }

  async function backToStart(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(!confirm("çµ‚äº†å…¥åŠ›ã‚’ç ´æ£„ã—ã¦ã€é–‹å§‹å…¥åŠ›ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;
    setStageStart();
  }

  // âœ… eventä¿å­˜payloadã‚’ç¸®å°ï¼šè§¦ã£ãŸ/ä½¿ã£ãŸå•†å“ã ã‘ä¿å­˜
  function buildEventLinesCompact(){
    const lines = [];
    for(const it of (master.items||[])){
      const s = start10[it.id] || 0;
      const e = end10[it.id];
      const touched = (s>0) || !(e===null || e===undefined);
      if(!touched) continue;

      const used10 = (e===null || e===undefined) ? null : (s - e);
      const used = (used10===null) ? null : (used10/10);
      const costYen = costYenById.get(it.id) || 0;
      const lineCostYen = (used!==null && used>0) ? Math.round(used * costYen) : 0;

      lines.push({
        id: it.id,
        name: it.name,
        unit: it.unit || "æœ¬",
        costYen,
        minQty: (it.minQty ?? null),
        start: s/10,
        end: (e===null || e===undefined) ? null : (e/10),
        used,
        lineCostYen
      });
    }
    return lines;
  }

  async function finishEvent(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(stage!=="end") return alert("â‘§ã¯â‘¦çµ‚äº†å…¥åŠ›ã®ã‚ã¨ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    const mSales = getDraftSalesYen();
    const m = {
      date: $("evDate").value || todayISO(),
      guests: parseIntSafe($("evGuests").value),
      drinkPricePerHeadYen: parseIntSafe($("evDrinkPrice").value),
      salesYen: mSales,
      extensionCount: Math.max(0, parseIntSafe($("evExt").value) || 0),
      durationMin: Number(($("evDuration").textContent||"90").replace(/[^\d]/g,"")) || 90,
      style: $("evStyle").value || "seated",
      staff: ($("evStaff").value||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,2)
    };

    if(agg.missingEnds>0){
      if(!confirm(`çµ‚äº†æœªå…¥åŠ›ãŒ ${agg.missingEnds} ä»¶ã‚ã‚Šã¾ã™ã€‚\næœªç¢ºå®šã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    }

    const payload = {
      version:2,
      date: m.date,
      guests: m.guests ?? null,
      drinkPricePerHeadYen: m.drinkPricePerHeadYen ?? null,
      salesYen: m.salesYen ?? null,
      extensionCount: m.extensionCount,
      durationMin: m.durationMin,
      style: m.style,
      staff: m.staff,
      totalCostYen: Math.round(agg.total),
      usedItemCount: agg.usedItemCount,
      missingEnds: agg.missingEnds,
      negativeCount: agg.negativeCount,
      isComplete: (agg.missingEnds===0),
      lines: buildEventLinesCompact()
    };

    const docKey = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"");
    const { error } = await sb.from("docs").insert({ user_id:u.id, kind:"event", doc_key:docKey, payload });
    if(error){
      log("finishEvent insert error", error);
      return alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }

    await deleteRemoteDraft();
    clearLocalDraft();

    // æ–°è¦é–‹å§‹çŠ¶æ…‹ã¸
    stage = "start";
    $("evDate").value = todayISO();
    $("evGuests").value = "";
    $("evDrinkPrice").value = "";
    $("evExt").value = "0";
    $("evStyle").value = "seated";
    $("evStaff").value = "";

    start10 = {};
    end10 = {};
    initQtyMaps();

    draftSavedAt = null;
    draftSavedBy = null;
    draftServerUpdatedAt = null;
    draftDirty = false;

    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateDurationUI();
    updateStageUI();
    updateAllKpis();

    alert("â‘§å®´ä¼šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆä¸€è¦§ã«è¿½åŠ ï¼‰ã€‚");
  }

  // -----------------------
  // â‘¢å®´ä¼šæƒ…å ±ãƒªã‚»ãƒƒãƒˆï¼ˆ2æ®µéšï¼‰
  // -----------------------
  let metaResetArmed = false;
  let metaResetTimer = null;

  function disarmMetaReset(){
    metaResetArmed = false;
    clearTimeout(metaResetTimer);
    $("btnMetaReset").classList.remove("danger","warn");
    $("btnMetaReset").classList.add("ghost");
    $("btnMetaReset").textContent = "â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰";
  }

  function clearMetaOnly(){
    $("evDate").value = todayISO();
    $("evGuests").value = "";
    $("evDrinkPrice").value = "";
    $("evExt").value = "0";
    $("evStyle").value = "seated";
    $("evStaff").value = "";
    updateDurationUI();
    updateAllKpis();
    markDraftDirty("meta reset");
  }

  function onMetaResetClick(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(stage==="end") return alert("â‘¦çµ‚äº†å…¥åŠ›ä¸­ã¯â‘¢ã‚’ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“ï¼ˆâ‘¥å–ã‚Šæ¶ˆã—ã§é–‹å§‹ã¸æˆ»ã—ã¦ã‹ã‚‰ï¼‰ã€‚");

    if(!metaResetArmed){
      metaResetArmed = true;
      $("btnMetaReset").classList.remove("ghost");
      $("btnMetaReset").classList.add("warn");
      $("btnMetaReset").textContent = "ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤";
      metaResetTimer = setTimeout(disarmMetaReset, 7000);
      return;
    }

    if(!confirm("â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ã—ã¾ã™ã€‚\nâ€»å•†å“å…¥åŠ›ï¼ˆé–‹å§‹/çµ‚äº†ï¼‰ã¯æ®‹ã‚Šã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
      disarmMetaReset();
      return;
    }
    clearMetaOnly();
    disarmMetaReset();
    alert("â‘¢å®´ä¼šæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
  }

  async function clearDraftAll(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(!confirm("ä¸‹æ›¸ãï¼ˆâ‘¢ã€œâ‘¦ã®é€”ä¸­çŠ¶æ…‹ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å–ã‚Šæ¶ˆã—ä¸å¯")) return;

    await deleteRemoteDraft();
    clearLocalDraft();

    stage = "start";
    $("evDate").value = todayISO();
    $("evGuests").value = "";
    $("evDrinkPrice").value = "";
    $("evExt").value = "0";
    $("evStyle").value = "seated";
    $("evStaff").value = "";

    start10 = {};
    end10 = {};
    initQtyMaps();

    draftSavedAt = null;
    draftSavedBy = null;
    draftServerUpdatedAt = null;
    draftDirty = false;

    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateDurationUI();
    updateStageUI();
    updateAllKpis();
    updateDraftInfoUI("å‰Šé™¤æ¸ˆã¿");
  }

  // -----------------------
  // âœ… Realtimeï¼šfilterã¯ user_id ã®ã¿ã«ã—ã¦kindã§åˆ†å²ï¼ˆå®‰å…¨ï¼‰
  // -----------------------
  function stopRealtime(){
    if(rtChannel){
      sb.removeChannel(rtChannel);
      rtChannel = null;
    }
    $("rtState").textContent = "OFF";
  }

  function upsertEventRow(row){
    if(!row || !row.doc_key) return;
    const key = row.doc_key;

    const existed = eventsByKey.get(key);
    eventsByKey.set(key, row);

    if(existed){
      const idx = events.findIndex(x => x.doc_key === key);
      if(idx>=0) events[idx] = row;
    }else{
      events.unshift(row);
    }

    // created_at descã‚’ç¶­æŒï¼ˆè»½é‡ãªç¯„å›²ã§ï¼‰
    events.sort((a,b) => (b.created_at||"").localeCompare(a.created_at||""));
    if(events.length > 400) events = events.slice(0,400);

    $("eventsCount").textContent = String(events.length);
    renderEvents();
  }

  function deleteEventRow(doc_key){
    if(!doc_key) return;
    eventsByKey.delete(doc_key);
    events = events.filter(x => x.doc_key !== doc_key);
    $("eventsCount").textContent = String(events.length);
    renderEvents();
  }

  async function startRealtime(){
    stopRealtime();
    const u = await getUser();
    if(!u) return;

    rtChannel = sb.channel("docs-rt-j");

    rtChannel.on("postgres_changes", {
      event:"*",
      schema:"public",
      table:"docs",
      filter:`user_id=eq.${u.id}`
    }, async (payload) => {
      $("rtState").textContent = "ON";

      const n = payload.new || null;
      const o = payload.old || null;

      const kind = (n && n.kind) ? n.kind : (o && o.kind) ? o.kind : null;
      const docKey = (n && n.doc_key) ? n.doc_key : (o && o.doc_key) ? o.doc_key : null;

      // master
      if(kind==="master" && docKey==="main"){
        await loadMaster(); // masterã¯ä¸¸ã”ã¨é©ç”¨ï¼ˆå®‰å…¨ï¼‰
        log("RT master applied", payload);
        return;
      }

      // draftï¼ˆè‡ªåˆ†ã®ä¿å­˜ãƒ«ãƒ¼ãƒ—å›é¿ã®ãŸã‚ã€ã‚µãƒ¼ãƒæ›´æ–°ãŒæ¥ãŸã‚‰é©ç”¨ï¼‰
      if(kind===DRAFT_KIND && docKey===DRAFT_KEY){
        const remote = await loadRemoteDraft();
        if(remote) applyDraftPayload(remote);
        log("RT draft applied", payload);
        return;
      }

      // eventï¼šå·®åˆ†æ›´æ–°ï¼ˆloadEventsã—ãªã„ï¼‰
      if(kind==="event"){
        if(payload.eventType === "DELETE"){
          deleteEventRow(docKey);
          log("RT event deleted", payload);
        }else{
          // INSERT/UPDATE
          upsertEventRow({
            doc_key: n.doc_key,
            payload: n.payload,
            created_at: n.created_at,
            updated_at: n.updated_at
          });
          log("RT event upsert", payload);
        }
        return;
      }
    });

    const { error } = await rtChannel.subscribe((status) => { $("rtState").textContent = status; });
    if(error) log("rt subscribe error", error);
  }

  // -----------------------
  // â‘¡å†èª­ã¿è¾¼ã¿ï¼šmaster + draft + events + realtime
  // -----------------------
  async function reloadAll(){
    const u = await refreshAuthState();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    setReloadBusy(true, "å†èª­ã¿è¾¼ã¿ä¸­â€¦ master/draft/events");
    try{
      await loadMaster();
      await loadEvents();

      const remote = await loadRemoteDraft();
      if(remote){
        applyDraftPayload(remote);
      }else{
        const local = loadLocalDraft();
        if(local) applyDraftPayload(local);
        else{
          $("evDate").value = todayISO();
          $("evExt").value = "0";
          updateDurationUI();
          initQtyMaps();
          buildProductsListIfNeeded(true);
          recomputeAggAll();
          updateStageUI();
          updateAllKpis();
          markDraftDirty("init"); // åˆå›æ ã‚’ä½œã‚‹
        }
      }

      await startRealtime();

      setMustReload(false);
      setReloadBusy(false, "å®Œäº† âœ…");

      showTab("banquet");
      setTimeout(scrollToMetaCard, 150);

    }catch(e){
      log("reloadAll error", e);
      setReloadBusy(false, "å¤±æ•—: " + (e?.message || e));
      alert("å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
    }
  }

  // -----------------------
  // Buttons wiring
  // -----------------------
  $("btnReloadNow").addEventListener("click", reloadAll);
  $("btnReloadRetry").addEventListener("click", reloadAll);

  $("btnAutofillMin").addEventListener("click", applyMinToAllStarts);

  $("btnConfirmStart").addEventListener("click", confirmStart);
  $("btnBackToStart").addEventListener("click", backToStart);
  $("btnFinishEvent").addEventListener("click", finishEvent);

  $("btnDraftSave").addEventListener("click", async () => {
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    await saveRemoteDraftNow();
  });
  $("btnDraftClear").addEventListener("click", clearDraftAll);

  $("btnStageStart").addEventListener("click", () => { if(stage==="start") return; backToStart(); });
  $("btnStageEnd").addEventListener("click", () => { if(stage==="end") return; alert("â‘¦çµ‚äº†å…¥åŠ›ã¯â‘¥é–‹å§‹ç¢ºå®šã®ã‚ã¨ã§ã™ã€‚"); });

  $("btnMetaReset").addEventListener("click", onMetaResetClick);
  $("btnUnlockMeta").addEventListener("click", () => {
    if(!confirm("â‘¥é–‹å§‹ç¢ºå®šã‚’å–ã‚Šæ¶ˆã—ã¦ã€é–‹å§‹å…¥åŠ›ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆçµ‚äº†å…¥åŠ›ã¯ç ´æ£„ï¼‰")) return;
    setStageStart();
  });

  $("btnClearFilter").addEventListener("click", () => {
    $("fFrom").value = "";
    $("fTo").value = "";
    renderEvents();
  });
  $("fFrom").addEventListener("change", renderEvents);
  $("fTo").addEventListener("change", renderEvents);

  $("btnDump").addEventListener("click", () => { log("DUMP", { master, stage, start10, end10, agg, eventsCount: events.length }); });

  ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => {
    $(id).addEventListener("change", () => {
      updateDurationUI();
      updateAllKpis();
      markDraftDirty("meta");
    });
  });

  $("btnAddMaster").addEventListener("click", () => {
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");

    const name = ($("mName").value || "").trim();
    const unit = ($("mUnit").value || "æœ¬").trim() || "æœ¬";
    const cost = parseNumberSafe($("mCost").value);
    const min = parseNumberSafe($("mMin").value);

    if(!name) return alert("å•†å“åã‚’å…¥ã‚Œã¦ãã ã•ã„");
    if(cost===null || cost<0) return alert("ä»•å…¥å˜ä¾¡ãŒä¸æ­£ã§ã™");

    let minQty = null;
    if($("mMin").value.trim() !== ""){
      if(min===null || min<0) return alert("æœ€ä½ç”¨æ„æ•°ãŒä¸æ­£ã§ã™");
      minQty = Number(min.toFixed(1));
    }

    const it = {
      id: crypto.randomUUID ? crypto.randomUUID() : (Date.now()+""),
      name,
      unit,
      costYen: Math.round(cost),
      minQty,
      category: ($("mCat").value || "").trim() || null,
      note: ($("mNote").value || "").trim() || null
    };

    master.items = [it, ...(master.items||[])];

    $("mName").value = "";
    $("mUnit").value = "æœ¬";
    $("mCost").value = "";
    $("mMin").value = "";
    $("mCat").value = "";
    $("mNote").value = "";

    rebuildItemCaches();
    initQtyMaps();
    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateAllKpis();
    renderMaster();
    markDraftDirty("master add");
  });

  $("btnSaveMaster").addEventListener("click", saveMaster);

  // login/logout
  $("btnLogin").addEventListener("click", async () => {
    const email = $("email").value.trim();
    const password = $("pw").value;
    if(!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      log("login error", error);
      return alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
    }
    await refreshAuthState();
    setMustReload(true);
    setReloadMsg("ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã€‚â‘¡ã‚’æŠ¼ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    showTab("banquet");
    window.scrollTo({ top:0, behavior:"smooth" });
  });

  $("btnLogout").addEventListener("click", async () => {
    stopRealtime();
    const { error } = await sb.auth.signOut();
    if(error) log("logout error", error);
    setMustReload(true);
    $("authState").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    setReloadMsg("â€”");
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
  });

  // -----------------------
  // Startup
  // -----------------------
  (async () => {
    $("evDate").value = todayISO();
    $("evExt").value = "0";
    updateDurationUI();

    const u = await refreshAuthState();
    setMustReload(true);
    setReloadMsg(u ? "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Šã€‚â‘¡ã‚’æŠ¼ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚" : "æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚â‘ ã‹ã‚‰ã€‚");

    buildProductsListIfNeeded(true);
    recomputeAggAll();
    updateStageUI();
    updateAllKpis();

    sb.auth.onAuthStateChange(async (event) => {
      log("auth state", { event });
      await refreshAuthState();
      setMustReload(true);
      setReloadMsg("èªè¨¼çŠ¶æ…‹ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚â‘¡ã‚’æŠ¼ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
      stopRealtime();
    });
  })();
})();
</script>
</body>
</html>
