<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <title>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰ - Sample G</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --muted:#5f6368;
      --text:#111827;
      --line:#e5e7eb;
      --accent:#2563eb;
      --danger:#dc2626;
      --warn:#d97706;

      --input-bg:#ffffff;
      --input-text:#111827;
      --input-border:#d1d5db;

      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    :root[data-theme="dark"]{
      --bg:#0b0b0c;
      --card:#141416;
      --muted:#9aa0a6;
      --text:#f2f3f4;
      --line:#26282c;
      --accent:#66e3ff;
      --danger:#ff6b6b;
      --warn:#ffb020;

      --input-bg:#0f1012;
      --input-text:#f2f3f4;
      --input-border:#26282c;

      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background: var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:5;
      background: color-mix(in oklab, var(--bg) 92%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px;
    }
    .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:16px; letter-spacing:.02em; }
    .topRight{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex; gap:8px; align-items:center;
      background: color-mix(in oklab, var(--card) 80%, transparent);
    }
    .themeBtn{
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      line-height:1;
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, var(--bg));
      color:var(--text);
      cursor:pointer;
    }

    nav{ display:flex; gap:8px; margin-top:10px; }
    .tab{
      flex:1;
      background:transparent;
      border:1px solid var(--line);
      color:var(--muted);
      padding:10px 8px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
    }
    .tab.active{
      color:var(--text);
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 15%, transparent) inset;
      background: color-mix(in oklab, var(--accent) 6%, transparent);
    }
    .tab.disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    /* â˜…èµ¤ã„ã€‡å›²ã¿æ•°å­—ï¼ˆiPadã§ã‚‚èª­ã‚ã‚‹ã‚µã‚¤ã‚ºï¼‰ */
    .stepNo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:999px;
      border:2px solid var(--danger);
      color:var(--danger);
      font-weight:900;
      font-size:16px;
      line-height:1;
      letter-spacing:.02em;
      transform: translateY(2px);
      flex:0 0 auto;
    }
    @media (min-width: 900px) and (orientation: landscape){
      .stepNo{
        width:34px;
        height:34px;
        font-size:19px;
        border-width:2.5px;
      }
    }

    /* â˜…æ‰‹é †ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»˜è¿‘ï¼‰ */
    .manualBar{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: color-mix(in oklab, var(--card) 88%, var(--bg));
      display:grid;
      gap:6px;
    }
    .manualLine{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .manualChip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color: var(--text);
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    main{
      padding:14px;
      max-width:1150px;
      margin:0 auto;
    }
    .grid{ display:grid; gap:12px; }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }

    input, select, textarea{
      width:100%;
      background: var(--input-bg);
      color: var(--input-text);
      border:1px solid var(--input-border);
      border-radius:12px;
      padding:12px;
      font-size:14px;
      outline:none;
    }

    button{
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, var(--bg));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
    }
    button.primary{
      border-color: color-mix(in oklab, var(--accent) 60%, var(--line));
      background: color-mix(in oklab, var(--accent) 10%, var(--card));
    }
    button.danger{
      border-color: color-mix(in oklab, var(--danger) 65%, var(--line));
      background: color-mix(in oklab, var(--danger) 10%, var(--card));
    }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* é€²è¡ŒUI */
    .stageWrap{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background: color-mix(in oklab, var(--card) 90%, var(--bg));
    }
    .seg button{
      border:none;
      border-right:1px solid var(--line);
      border-radius:0;
      padding:10px 14px;
      font-size:13px;
      background:transparent;
      color:var(--muted);
    }
    .seg button:last-child{ border-right:none; }
    .seg button.active{
      color:var(--text);
      background: color-mix(in oklab, var(--accent) 10%, var(--card));
    }
    .statusDot{
      width:10px; height:10px; border-radius:50%;
      background: color-mix(in oklab, var(--warn) 70%, transparent);
      display:inline-block;
    }
    .statusDot.ok{ background: color-mix(in oklab, #22c55e 70%, transparent); }
    .statusDot.run{ background: color-mix(in oklab, var(--accent) 70%, transparent); }

    /* KPI */
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: color-mix(in oklab, var(--card) 92%, var(--bg));
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; margin-top:4px; }

    .list{ display:grid; gap:10px; }
    .item{
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 92%, var(--bg));
      border-radius:14px;
      padding:12px;
    }
    .itemHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .itemHeader h3{ margin:0; font-size:14px; }

    .badge{
      font-size:11px; color:var(--muted);
      padding:4px 8px; border:1px solid var(--line);
      border-radius:999px; white-space:nowrap;
      background: color-mix(in oklab, var(--card) 80%, transparent);
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.warn{
      color: color-mix(in oklab, var(--warn) 80%, var(--text));
      border-color: color-mix(in oklab, var(--warn) 45%, var(--line));
      background: color-mix(in oklab, var(--warn) 8%, var(--card));
    }

    /* å•†å“è¡Œï¼š2ã‚«ãƒ©ãƒ  */
    .prodRow{
      display:grid;
      grid-template-columns: 1fr 560px;
      gap:10px;
      align-items:center;
      padding:12px 0;
      border-top:1px dashed color-mix(in oklab, var(--text) 12%, transparent);
    }
    .prodRow:first-child{ border-top:none; padding-top:0; }

    .prodName{
      font-size:16px;
      font-weight:700;
      text-align:center;
      letter-spacing:.02em;
    }
    .prodMeta{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      text-align:center;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }

    .ctrlBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: color-mix(in oklab, var(--card) 92%, var(--bg));
    }
    .ctrlBox.startBox{
      background: color-mix(in oklab, #ef4444 7%, var(--card));
      border-color: color-mix(in oklab, #ef4444 22%, var(--line));
    }
    .ctrlBox.endBox{
      background: color-mix(in oklab, #3b82f6 7%, var(--card));
      border-color: color-mix(in oklab, #3b82f6 22%, var(--line));
    }
    .ctrlBox.readonly{
      opacity:.92;
      filter:saturate(.9);
    }

    .ctrlTitle{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted);
      margin-bottom:10px;
    }

    .ctrlGrid{
      display:grid;
      grid-template-columns: 48px 62px 1fr 62px 48px;
      gap:8px;
      align-items:center;
    }

    .stepBtn{
      height:48px;
      display:flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, var(--bg));
      user-select:none;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
    }

    .startBox .stepBtn.primary{
      border-color: color-mix(in oklab, #ef4444 45%, var(--line));
      background: color-mix(in oklab, #ef4444 10%, var(--card));
    }
    .endBox .stepBtn.primary{
      border-color: color-mix(in oklab, #3b82f6 45%, var(--line));
      background: color-mix(in oklab, #3b82f6 10%, var(--card));
    }

    .qtyInput{
      text-align:center;
      font-size:18px;
      padding:12px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 78%, var(--bg));
      height:48px;
    }

    .roQty{
      height:48px;
      border-radius:12px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 78%, var(--bg));
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      font-weight:800;
    }

    .usedBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background: color-mix(in oklab, var(--card) 92%, var(--bg));
      display:flex;
      flex-direction:column;
      gap:8px;
      justify-content:center;
      align-items:flex-end;
      min-height:100%;
    }
    .usedLine{ font-size:12px; color:var(--muted); }
    .usedVal{ font-size:18px; font-weight:800; }
    .usedVal.negative{ color: var(--danger); }
    .usedVal.missing{ color: var(--warn); }

    /* Masterï¼šæ¨ªå‘ã2ã‚«ãƒ©ãƒ  */
    .masterSplit{
      display:grid;
      gap:12px;
    }

    @media (max-width: 980px){
      .prodRow{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      .usedBox{ align-items:flex-start; }
      .masterSplit{ grid-template-columns: 1fr; }
    }

    /* iPadæ¨ªï¼ˆã–ã£ãã‚Šï¼‰ */
    @media (min-width: 900px) and (max-width: 1100px) and (orientation: landscape){
      main{ max-width:1024px; padding:12px; }
      .kpiGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .prodRow{ grid-template-columns: 360px 1fr; gap:12px; }

      .controls{
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "start end"
          "used used";
        gap:12px;
      }
      .startArea{ grid-area:start; }
      .endArea{ grid-area:end; }
      .usedArea{ grid-area:used; }
      .usedBox{ align-items:flex-start; }

      .masterSplit{ grid-template-columns: 420px 1fr; align-items:start; }
      .stepBtn{ height:52px; }
      .qtyInput{ height:52px; font-size:19px; }
      .roQty{ height:52px; font-size:19px; }
    }

    /* â‘¡å†èª­ã¿è¾¼ã¿å¿…é ˆãƒ­ãƒƒã‚¯ */
    .locked{
      pointer-events:none;
      opacity:.55;
      filter: saturate(.85);
    }
    .lockNote{
      border:1px solid color-mix(in oklab, var(--warn) 40%, var(--line));
      background: color-mix(in oklab, var(--warn) 8%, var(--card));
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <h1>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰- Sample G</h1>
    <div class="topRight">
      <button id="btnTheme" class="themeBtn" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span></button>
      <div class="pill"><span id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</span> <span class="mono" id="deviceId">â€”</span></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="banquet" id="tabBtnBanquet">å®´ä¼š</button>
    <button class="tab" data-tab="master" id="tabBtnMaster">å•†å“ãƒã‚¹ã‚¿</button>
    <button class="tab" data-tab="sync" id="tabBtnSync">åŒæœŸ/ãƒ­ã‚°</button>
  </nav>

  <!-- â˜…æ‰‹é †ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆâ‘¡ãŒè¿½åŠ ã•ã‚Œã€ä»¥é™ãŒ1ã¤ãšã¤ç¹°ã‚Šä¸‹ã’ï¼‰ -->
  <div class="manualBar">
    <div class="manualLine">
      <span class="manualChip"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³</span>
      <span class="manualChip"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰</span>
      <span class="manualChip"><span class="stepNo">3</span>å®´ä¼šæƒ…å ±å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">4</span>å•†å“å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰</span>
      <span class="manualChip"><span class="stepNo">5</span>é–‹å§‹ç¢ºå®š</span>
      <span class="manualChip"><span class="stepNo">6</span>çµ‚äº†å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">7</span>å®´ä¼šä¿å­˜</span>
    </div>
    <div class="manualLine">
      <span class="manualChip">ä¿å­˜å¾Œï¼šå®´ä¼šä¸€è¦§ã§ç¢ºèªï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¯ï¼‰</span>
      <span class="manualChip">â‘¤é–‹å§‹ç¢ºå®šã—ãŸã‚‰é–‰ã˜ã¦OKï¼ˆä¸‹æ›¸ããŒåŒæœŸï¼†å¾©å…ƒï¼‰</span>
    </div>
  </div>
</header>

<main>
  <!-- BANQUET -->
  <section id="tab-banquet" class="grid">

    <!-- â‘ ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåº—èˆ—å…±é€šï¼‰</h2>
      <div class="row">
        <div>
          <label>åº—èˆ—å…±é€šãƒ¡ãƒ¼ãƒ«</label>
          <input id="email" type="email" placeholder="ä¾‹ï¼šstore@example.com" />
        </div>
        <div>
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input id="pw" type="password" placeholder="********" />
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="ghost" id="btnLogout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="small">â€»åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹è¤‡æ•°iPadé–“ã§ã€ãƒã‚¹ã‚¿/å®´ä¼šä¸‹æ›¸ããŒè‡ªå‹•åŒæœŸã—ã¾ã™ï¼ˆRealtimeï¼‰ã€‚</div>
    </div>

    <!-- â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰ -->
    <div class="card" id="reloadCard" style="display:none;">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰</h2>
      <div class="lockNote">
        <div style="flex:0 0 auto; transform:translateY(1px);">âš ï¸</div>
        <div>
          <div style="font-weight:800; margin-bottom:4px;">ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã¯å¿…ãšã€Œå†èª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
          <div class="small">
            ã“ã‚Œã‚’æŠ¼ã™ã¾ã§ã€å®´ä¼šå…¥åŠ›ãƒ»ãƒã‚¹ã‚¿ç·¨é›†ãƒ»åŒæœŸã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚<br>
            ï¼ˆç¾å ´ã§ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã¤ã‚‚ã‚Šã€ã€Œå¤ã„ãƒ‡ãƒ¼ã‚¿ã®ã¾ã¾ã€ã‚’é˜²ãã¾ã™ï¼‰
          </div>
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnReloadNow"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹</button>
      </div>
      <div class="small">â€»æŠ¼ã—ãŸå¾Œã€ãƒã‚¹ã‚¿/å®´ä¼šä¸€è¦§/ä¸‹æ›¸ãï¼ˆã‚ã‚Œã°ï¼‰ãŒæœ€æ–°åŒ–ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <!-- â‘¡ãŒçµ‚ã‚ã‚‹ã¾ã§ãƒ­ãƒƒã‚¯ã™ã‚‹é ˜åŸŸ -->
    <div id="appArea" class="grid locked">

      <!-- â˜…UIé †å¤‰æ›´ï¼šâ‘¢å®´ä¼šæƒ…å ± â†’ é€²è¡Œ -->
      <!-- â‘¢å®´ä¼šæƒ…å ± -->
      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">3</span>å®´ä¼š æƒ…å ±ï¼ˆâ‘¤é–‹å§‹ç¢ºå®šå¾Œã¯ãƒ­ãƒƒã‚¯ï¼‰</h2>

        <div class="row">
          <div>
            <label>æ—¥ä»˜</label>
            <input id="evDate" type="date" />
          </div>
          <div>
            <label>äººæ•°</label>
            <input id="evGuests" inputmode="numeric" placeholder="ä¾‹ï¼š30" />
          </div>
          <div>
            <label>é£²ã¿æ”¾é¡Œå˜ä¾¡ï¼ˆå††/äººï¼‰</label>
            <input id="evDrinkPrice" inputmode="numeric" placeholder="ä¾‹ï¼š3000" />
            <div class="small">è¦‹è¾¼ã¿å£²ä¸Šï¼äººæ•°Ã—å˜ä¾¡</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é£²ã¿æ”¾é¡Œï¼ˆåŸºæœ¬90åˆ† + å»¶é•·30åˆ†å˜ä½ï¼‰</label>
            <div class="row" style="margin:0;">
              <div style="min-width:220px; flex:1;">
                <input id="evExt" inputmode="numeric" placeholder="å»¶é•·å›æ•°ï¼ˆ0ã€œï¼‰ä¾‹ï¼š1" />
                <div class="small">å»¶é•·å›æ•° Ã— 30åˆ†</div>
              </div>
              <div class="kpi" style="flex:1;">
                <div class="t">åˆè¨ˆæ™‚é–“</div>
                <div class="v mono" id="evDuration">90åˆ†</div>
              </div>
            </div>
          </div>

          <div>
            <label>ç€å¸­ / ç«‹é£Ÿ</label>
            <select id="evStyle">
              <option value="seated">ç€å¸­</option>
              <option value="standing">ç«‹é£Ÿ</option>
            </select>
          </div>

          <div>
            <label>ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ‹…å½“è€…ï¼ˆ1ã€œ2åã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="evStaff" placeholder="ä¾‹ï¼šå±±ç”°, ä½è—¤" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ï¼ˆçµ‚äº†å…¥åŠ›åˆ†ã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiThisCost">Â¥0</div>
            <div class="small" id="kpiMissingEnds">æœªå…¥åŠ› 0</div>
          </div>

          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿å£²ä¸Šï¼ˆäººæ•°Ã—å˜ä¾¡ï¼‰</div>
            <div class="v mono" id="kpiThisSales">â€”</div>
            <div class="small" id="kpiSalesHint">äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—</div>
          </div>

          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ç‡ï¼ˆåŸä¾¡Ã·å£²ä¸Šï¼‰</div>
            <div class="v mono" id="kpiThisCostRate">â€”</div>
            <div class="small" id="kpiThisStatus">çŠ¶æ…‹ï¼šæœªç¢ºå®š</div>
          </div>

          <div class="kpi">
            <div class="t">å•†å“ç‚¹æ•°ï¼ˆä½¿ç”¨æ•°&gt;0ï¼‰</div>
            <div class="v mono" id="kpiThisItems">0</div>
            <div class="small">ä½¿ç”¨æ•°ï¼é–‹å§‹âˆ’çµ‚äº†</div>
          </div>
        </div>
      </div>

      <!-- é€²è¡Œï¼ˆä¸‹æ›¸ãï¼‰ + â‘¤â‘¥â‘¦ -->
      <div class="card">
        <div class="stageWrap">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="statusDot" id="draftDot"></span>
            <div>
              <div style="font-size:14px; font-weight:800;">é€²è¡Œï¼š<span id="stageLabel">é–‹å§‹å…¥åŠ›</span></div>
              <div class="small mono" id="draftInfo">ä¸‹æ›¸ãï¼šæœªä¿å­˜</div>
            </div>
          </div>

          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="seg">
              <button id="btnStageStart" class="active" type="button"><span class="stepNo">4</span>é–‹å§‹å…¥åŠ›</button>
              <button id="btnStageEnd" type="button"><span class="stepNo">6</span>çµ‚äº†å…¥åŠ›</button>
            </div>
            <button class="ghost" id="btnDraftSave" type="button">é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
            <button class="danger" id="btnDraftClear" type="button">ä¸‹æ›¸ãã‚’å‰Šé™¤</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnbar" style="margin-top:0;">
          <button class="primary" id="btnConfirmStart" type="button">
            <span class="stepNo">5</span>é–‹å§‹ã‚’ç¢ºå®šï¼ˆåŒæœŸã—ã¦ä¿å­˜ï¼‰â†’ <span class="stepNo">6</span>çµ‚äº†å…¥åŠ›ã¸
          </button>
          <button class="ghost" id="btnBackToStart" type="button">
            é–‹å§‹ã‚’ç·¨é›†ã—ç›´ã™ï¼ˆçµ‚äº†å…¥åŠ›ã‚’ç ´æ£„ï¼‰
          </button>
          <button class="primary" id="btnFinishEvent" type="button">
            <span class="stepNo">7</span>å®´ä¼šã‚’å®Œäº†ã—ã¦ä¿å­˜ï¼ˆeventã«ç¢ºå®šï¼‰
          </button>
        </div>

        <div class="small" style="margin-top:8px;">
          âœ…â‘¤é–‹å§‹ç¢ºå®šå¾Œã¯ã€Œé–‹å§‹ã€ã¨ã€Œå®´ä¼šæƒ…å ±ã€ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰ã€‚<br>
          â€»è¤‡æ•°ç«¯æœ«ã§åŒæ™‚ç·¨é›†ã¯ä¸Šæ›¸ãã—åˆã†ã®ã§ã€åŸºæœ¬ã¯ã€Œæ‹…å½“1å°ã€ã§é‹ç”¨æ¨å¥¨ã€‚
        </div>
      </div>

      <!-- â‘£å•†å“å…¥åŠ› + ç›®å®‰ä¸€æ‹¬å…¥åŠ›ãƒœã‚¿ãƒ³ -->
      <div class="card">
        <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0 0 6px; font-size:15px;"><span class="stepNo">4</span>å•†å“å…¥åŠ›ï¼ˆé–‹å§‹ / çµ‚äº†ï¼‰</h2>
            <div class="small" id="productsHint">
              é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¤é–‹å§‹ç¢ºå®šã€‚çµ‚äº†ãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã¯å›ºå®šã€â‘¥çµ‚äº†å…¥åŠ› â†’ â‘¦ä¿å­˜ã€‚
            </div>
          </div>

          <div class="btnbar" style="margin-top:0;">
            <button class="primary" id="btnAutofillMin" type="button">
              ç›®å®‰ã¾ã§ä¸€æ‹¬å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰
            </button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="products" class="list"></div>
        <div id="noProducts" class="small">å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚ã€Œå•†å“ãƒã‚¹ã‚¿ã€ã‚¿ãƒ–ã§å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <!-- ä¸€è¦§ -->
      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;">å®´ä¼šä¸€è¦§ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰ï¼‹ç´¯è¨ˆ</h2>

        <div class="row">
          <div>
            <label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé–‹å§‹æ—¥ï¼‰</label>
            <input id="fFrom" type="date" />
          </div>
          <div>
            <label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆçµ‚äº†æ—¥ï¼‰</label>
            <input id="fTo" type="date" />
          </div>
          <div>
            <label>æ“ä½œ</label>
            <div class="btnbar" style="margin-top:0;">
              <button class="ghost" id="btnClearFilter">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
            </div>
          </div>
        </div>

        <div class="kpiGrid" style="margin-top:10px;">
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿åŸä¾¡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumCostComplete">Â¥0</div>
            <div class="small">æœªå…¥åŠ›ãŒç„¡ã„å®´ä¼šã®ã¿</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿å£²ä¸Šï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumSalesComplete">Â¥0</div>
            <div class="small">äººæ•°Ã—å˜ä¾¡ï¼ˆæœªå…¥åŠ›ã¯é™¤å¤–ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ åŸä¾¡ç‡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiSumCostRateComplete">â€”</div>
            <div class="small">åŸä¾¡Ã·å£²ä¸Š</div>
          </div>
          <div class="kpi">
            <div class="t">ç´¯è¨ˆ äººæ•° / å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰</div>
            <div class="v mono" id="kpiSumGuests">0</div>
            <div class="small mono" id="kpiAvgPerHead">â€”</div>
          </div>
        </div>

        <div class="hr"></div>
        <div id="events" class="list"></div>
        <div id="noEvents" class="small">ã¾ã å®´ä¼šãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>

    </div><!-- /appArea locked -->
  </section>

  <!-- MASTER -->
  <section id="tab-master" class="grid" style="display:none;">
    <div class="masterSplit">
      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;">å•†å“ãƒã‚¹ã‚¿ï¼ˆç«¯æœ«é–“åŒæœŸï¼‰</h2>

        <div class="row">
          <div>
            <label>å•†å“å</label>
            <input id="mName" placeholder="ä¾‹ï¼šç”Ÿãƒ“ãƒ¼ãƒ« / ãƒã‚¤ãƒœãƒ¼ãƒ«ç”¨ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ / ãƒ¯ã‚¤ãƒ³èµ¤" />
          </div>
          <div>
            <label>å˜ä½ï¼ˆä¾‹ï¼šæœ¬/æ¨½/ç¼¶ï¼‰</label>
            <input id="mUnit" placeholder="ä¾‹ï¼šæœ¬" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>ä»•å…¥å˜ä¾¡ï¼ˆå††/1å˜ä½ï¼‰</label>
            <input id="mCost" inputmode="numeric" placeholder="ä¾‹ï¼š4800" />
          </div>
          <div>
            <label>æœ€ä½ç”¨æ„æ•°ï¼ˆæœ¬ï¼‰</label>
            <input id="mMin" inputmode="decimal" placeholder="ä¾‹ï¼š6ï¼ˆç›®å®‰ï¼‰" />
            <div class="small">åˆå¿ƒè€…ãŒæº–å‚™ã—ã‚„ã™ã„ç›®å®‰ã€‚â‘£é–‹å§‹å…¥åŠ›ã®ã€Œç›®å®‰ä¸€æ‹¬å…¥åŠ›ã€ã«ä½¿ã„ã¾ã™ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label>
            <input id="mCat" placeholder="ä¾‹ï¼šBEER / WHISKY / WINE / SOFT" />
          </div>
          <div>
            <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <input id="mNote" placeholder="ä¾‹ï¼š20Læ¨½ / 700mlãƒœãƒˆãƒ«" />
          </div>
        </div>

        <div class="btnbar">
          <button class="primary" id="btnAddMaster">ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
          <button class="ghost" id="btnSaveMaster">ãƒã‚¹ã‚¿ã‚’ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;">ç™»éŒ²æ¸ˆã¿ãƒã‚¹ã‚¿</h2>
        <div id="masterList" class="list"></div>
        <div id="noMaster" class="small">ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚</div>
      </div>
    </div>
  </section>

  <!-- SYNC/LOG -->
  <section id="tab-sync" class="grid" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">åŒæœŸ/ãƒ­ã‚°</h2>
      <div class="row">
        <div class="pill">Realtime: <b id="rtState">â€”</b></div>
        <div class="pill">master updated_at: <b id="masterUpdated">â€”</b></div>
        <div class="pill">events loaded: <b id="eventsCount">0</b></div>
      </div>

      <div class="btnbar">
        <button class="ghost" id="btnDump">ç¾åœ¨ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºã™</button>
      </div>

      <div class="hr"></div>
      <div class="small">ãƒ­ã‚°</div>
      <pre id="log" class="mono" style="white-space:pre-wrap; background:var(--input-bg); border:1px solid var(--line); padding:12px; border-radius:14px; margin:0;">-</pre>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
(() => {
  // =======================
  // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼šè‡ªå‹•å…¥åŠ›æ¸ˆã¿
  // =======================
  const SUPABASE_URL = "https://pftjjrluhdbovoaxnykn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdGpqcmx1aGRib3ZvYXhueWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzUzMTUsImV4cCI6MjA4NjcxMTMxNX0.qX-LpvYcbu589h96FdxJmUEqYto64wniBcuGXraJaoU";
  // =======================

  const DRAFT_KIND = "event_draft";
  const DRAFT_KEY  = "active";
  const LOCAL_DRAFT_KEY = "banquet_draft_v1";

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id) => document.getElementById(id);

  // theme
  const THEME_KEY = "banquet_theme";
  function applyTheme(theme){
    document.documentElement.dataset.theme = theme;
    const btn = $("btnTheme");
    if(btn){
      btn.innerHTML = theme === "dark"
        ? `ğŸŒ™ <span class="mono" style="font-size:12px;">DARK</span>`
        : `â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span>`;
    }
    localStorage.setItem(THEME_KEY, theme);
  }
  applyTheme(localStorage.getItem(THEME_KEY) || "light");
  $("btnTheme").addEventListener("click", () => {
    const now = document.documentElement.dataset.theme || "light";
    applyTheme(now === "dark" ? "light" : "dark");
  });

  // device id
  const DID_KEY = "banquet_device_id";
  function getOrCreateDeviceId(){
    let did = localStorage.getItem(DID_KEY);
    if(!did){
      did = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      localStorage.setItem(DID_KEY, did);
    }
    return did;
  }
  $("deviceId").textContent = getOrCreateDeviceId();

  // tabs
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      if(btn.classList.contains("disabled")) return;
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["banquet","master","sync"].forEach(k => {
        $("tab-"+k).style.display = (k === tab) ? "" : "none";
      });
      if(tab === "master") renderMaster();
      if(tab === "banquet") { renderProducts(); renderEvents(); }
    });
  });

  // ===== â‘¡å†èª­ã¿è¾¼ã¿ã‚’å¿…é ˆåŒ–ã™ã‚‹ =====
  let mustReload = false;
  function setMustReload(on){
    mustReload = !!on;
    $("reloadCard").style.display = mustReload ? "" : "none";
    $("appArea").classList.toggle("locked", mustReload);

    // ã‚¿ãƒ–ã‚‚åˆ¶é™ï¼ˆå®´ä¼šä»¥å¤–ã‚’è§¦ã‚‰ã›ãªã„ï¼‰
    $("tabBtnMaster").classList.toggle("disabled", mustReload);
    $("tabBtnSync").classList.toggle("disabled", mustReload);

    if(mustReload){
      // å¿…ãšå®´ä¼šã‚¿ãƒ–ã«æˆ»ã™
      $("tabBtnBanquet").click();
    }
  }

  // state
  let master = { version:1, items:[], lastSavedAt:null, lastSavedBy:null };
  let masterRowUpdatedAt = null;
  let events = [];

  // draft state
  let stage = "start"; // "start" or "end"
  let draftServerUpdatedAt = null;
  let draftSavedAt = null;
  let draftSavedBy = null;
  let draftDirty = false;

  // qty maps (10x for 0.1 precision)
  let start10 = {}; // itemId -> int
  let end10 = {};   // itemId -> int | null (null=æœªå…¥åŠ›)

  function log(msg, obj){
    const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : "");
    $("log").textContent = line + "\n\n" + $("log").textContent;
  }

  function yen(n){
    const v = Math.round((n || 0));
    return "Â¥" + v.toLocaleString("ja-JP");
  }
  function pct(n){
    if(!Number.isFinite(n)) return "â€”";
    return (n*100).toFixed(1) + "%";
  }
  function todayISO(){
    const d = new Date();
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  function parseIntSafe(v){
    const s = String(v ?? "").replace(/,/g,"").trim();
    if(!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? Math.trunc(n) : null;
  }
  function parseNumberSafe(v){
    const s = String(v ?? "").replace(/,/g,"").trim();
    if(s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }
  function to10(x){ return Math.round(Number(x||0) * 10); }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function getUser(){
    const { data, error } = await sb.auth.getUser();
    if(error) log("auth.getUser error", error);
    return data?.user || null;
  }
  async function refreshAuthState(){
    const u = await getUser();
    $("authState").textContent = u ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${u.email || "(no email)"}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return u;
  }

  async function ensureMasterRow(){
    const u = await getUser();
    if(!u) throw new Error("not logged in");

    const { data, error } = await sb
      .from("docs")
      .select("payload, updated_at")
      .eq("kind", "master")
      .eq("doc_key", "main")
      .limit(1)
      .maybeSingle();

    if(error) throw error;

    if(!data){
      const seed = {
        version: 1,
        items: [],
        lastSavedAt: null,
        lastSavedBy: getOrCreateDeviceId(),
      };

      const ins = await sb
        .from("docs")
        .insert({
          user_id: u.id,
          kind: "master",
          doc_key: "main",
          payload: seed
        })
        .select("payload, updated_at")
        .single();

      if(ins.error) throw ins.error;
      return ins.data;
    }
    return data;
  }

  function initQtyMaps(){
    const s = {};
    const e = {};
    (master.items || []).forEach(it => {
      s[it.id] = (start10[it.id] ?? 0);
      e[it.id] = (end10[it.id] === undefined) ? null : end10[it.id];
    });
    start10 = { ...s };
    end10 = { ...e };
  }

  function updateDurationUI(){
    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    const min = 90 + 30 * ext;
    $("evDuration").textContent = `${min}åˆ†`;
  }

  function getDraftSalesYen(){
    const guests = parseIntSafe($("evGuests").value);
    const per = parseIntSafe($("evDrinkPrice").value);
    if(!guests || guests <= 0) return null;
    if(!per || per <= 0) return null;
    return guests * per;
  }

  function calcDraft(){
    let total = 0;
    let usedItemCount = 0;
    let missingEnds = 0;
    let negativeCount = 0;

    for(const it of (master.items || [])){
      const s10 = start10[it.id] || 0;
      const e10 = end10[it.id];

      if(s10 > 0 && (e10 === null || e10 === undefined)){
        missingEnds++;
      }
      if(e10 === null || e10 === undefined) continue;

      const used10 = s10 - e10;
      if(used10 < 0) negativeCount++;

      const used = used10 / 10;
      if(used > 0){
        usedItemCount++;
        total += used * Number(it.costYen || 0);
      }
    }
    return { total, usedItemCount, missingEnds, negativeCount };
  }

  function recalcKpi(){
    const { total, usedItemCount, missingEnds, negativeCount } = calcDraft();
    const sales = getDraftSalesYen();

    $("kpiThisCost").textContent = yen(total);
    $("kpiThisItems").textContent = String(usedItemCount);
    $("kpiMissingEnds").textContent = `æœªå…¥åŠ› ${missingEnds}` + (negativeCount ? ` / å¢—åŠ ç–‘ã„ ${negativeCount}` : "");

    if(sales !== null){
      $("kpiThisSales").textContent = yen(sales);
      const rate = (sales > 0) ? (total / sales) : NaN;
      $("kpiThisCostRate").textContent = pct(rate);
      $("kpiSalesHint").textContent = "â€”";
    }else{
      $("kpiThisSales").textContent = "â€”";
      $("kpiThisCostRate").textContent = "â€”";
      $("kpiSalesHint").textContent = "äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—";
    }

    const status =
      (stage === "start")
        ? "çŠ¶æ…‹ï¼šâ‘£é–‹å§‹å…¥åŠ›ä¸­ï¼ˆâ‘¥çµ‚äº†æœªå…¥åŠ›ï¼‰"
        : ((missingEnds === 0) ? "çŠ¶æ…‹ï¼šç¢ºå®šï¼ˆâ‘¦ä¿å­˜å¯èƒ½ï¼‰" : "çŠ¶æ…‹ï¼šæœªç¢ºå®šï¼ˆçµ‚äº†æœªå…¥åŠ›ã‚ã‚Šï¼‰");
    $("kpiThisStatus").textContent = status;
  }

  // ===== draft payload =====
  function buildDraftPayload(){
    const date = $("evDate").value || todayISO();
    const guests = parseIntSafe($("evGuests").value);
    const drinkPricePerHeadYen = parseIntSafe($("evDrinkPrice").value);
    const salesYen = (guests && drinkPricePerHeadYen) ? (guests * drinkPricePerHeadYen) : null;

    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    const durationMin = 90 + 30 * ext;

    const style = $("evStyle").value;
    const staff = ($("evStaff").value || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .slice(0, 2);

    const now = new Date().toISOString();
    return {
      version: 1,
      stage,
      meta: {
        date,
        guests: guests ?? null,
        drinkPricePerHeadYen: drinkPricePerHeadYen ?? null,
        salesYen,
        extensionCount: ext,
        durationMin,
        style,
        staff
      },
      start10,
      end10,
      savedAt: now,
      savedBy: getOrCreateDeviceId()
    };
  }

  function applyDraftPayload(p){
    if(!p || typeof p !== "object") return;

    stage = (p.stage === "end") ? "end" : "start";

    const m = p.meta || {};
    $("evDate").value = m.date || todayISO();
    $("evGuests").value = (m.guests ?? "") === null ? "" : String(m.guests ?? "");
    $("evDrinkPrice").value = (m.drinkPricePerHeadYen ?? "") === null ? "" : String(m.drinkPricePerHeadYen ?? "");
    $("evExt").value = String(m.extensionCount ?? 0);
    $("evStyle").value = m.style || "seated";
    $("evStaff").value = (m.staff || []).join(", ");

    start10 = (p.start10 && typeof p.start10 === "object") ? p.start10 : {};
    end10 = (p.end10 && typeof p.end10 === "object") ? p.end10 : {};

    draftSavedAt = p.savedAt || null;
    draftSavedBy = p.savedBy || null;
    draftDirty = false;

    initQtyMaps();
    updateDurationUI();
    updateStageUI();
    renderProducts();
    recalcKpi();
  }

  function loadLocalDraft(){
    const raw = localStorage.getItem(LOCAL_DRAFT_KEY);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }

  function saveLocalDraft(p){
    localStorage.setItem(LOCAL_DRAFT_KEY, JSON.stringify(p));
  }

  function clearLocalDraft(){
    localStorage.removeItem(LOCAL_DRAFT_KEY);
  }

  // ===== remote draft =====
  let draftSaveTimer = null;
  let draftSaving = false;

  async function loadRemoteDraft(){
    const u = await getUser();
    if(!u) return null;

    const { data, error } = await sb
      .from("docs")
      .select("payload, updated_at")
      .eq("kind", DRAFT_KIND)
      .eq("doc_key", DRAFT_KEY)
      .limit(1)
      .maybeSingle();

    if(error){
      log("loadRemoteDraft error", error);
      return null;
    }
    if(!data) return null;

    draftServerUpdatedAt = data.updated_at || null;
    return data.payload || null;
  }

  async function saveRemoteDraft(){
    const u = await getUser();
    if(!u) return;

    if(draftSaving) return;
    draftSaving = true;

    const payload = buildDraftPayload();
    try{
      const { data, error } = await sb
        .from("docs")
        .upsert({
          user_id: u.id,
          kind: DRAFT_KIND,
          doc_key: DRAFT_KEY,
          payload
        }, { onConflict: "user_id,kind,doc_key" })
        .select("updated_at")
        .single();

      if(error) throw error;

      draftServerUpdatedAt = data?.updated_at || null;
      draftSavedAt = payload.savedAt;
      draftSavedBy = payload.savedBy;
      draftDirty = false;
      updateDraftInfoUI("åŒæœŸæ¸ˆã¿");
    }catch(e){
      log("saveRemoteDraft failed", e);
      updateDraftInfoUI("åŒæœŸå¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼‰");
    }finally{
      draftSaving = false;
    }
  }

  function scheduleDraftSave(){
    const payload = buildDraftPayload();
    saveLocalDraft(payload);
    draftDirty = true;
    updateDraftInfoUI("ä¿å­˜ä¸­â€¦");

    clearTimeout(draftSaveTimer);
    draftSaveTimer = setTimeout(() => {
      saveRemoteDraft().catch(()=>{});
    }, 700);
  }

  function updateDraftInfoUI(extra){
    const dot = $("draftDot");
    const label = $("draftInfo");

    const saved = draftSavedAt ? `savedAt ${draftSavedAt}` : "æœªä¿å­˜";
    const by = draftSavedBy ? ` / by ${draftSavedBy}` : "";
    const server = draftServerUpdatedAt ? ` / server ${draftServerUpdatedAt}` : "";
    const dirty = draftDirty ? " / *dirty" : "";

    label.textContent = `ä¸‹æ›¸ãï¼š${saved}${by}${server}${dirty}` + (extra ? ` / ${extra}` : "");

    dot.classList.remove("ok","run");
    if(stage === "end") dot.classList.add("run");
    if(!draftDirty && draftSavedAt) dot.classList.add("ok");
  }

  function updateStageUI(){
    $("stageLabel").textContent = (stage === "start") ? "â‘£é–‹å§‹å…¥åŠ›" : "â‘¥çµ‚äº†å…¥åŠ›";
    $("btnStageStart").classList.toggle("active", stage === "start");
    $("btnStageEnd").classList.toggle("active", stage === "end");

    $("btnConfirmStart").style.display = (stage === "start") ? "" : "none";
    $("btnFinishEvent").style.display = (stage === "end") ? "" : "none";
    $("btnBackToStart").style.display = (stage === "end") ? "" : "none";

    $("btnAutofillMin").style.display = (stage === "start") ? "" : "none";

    $("productsHint").textContent =
      (stage === "start")
        ? "é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¤é–‹å§‹ç¢ºå®šã€‚ç›®å®‰ãŒã‚ã‚‹å•†å“ã¯ã€Œç›®å®‰ä¸€æ‹¬å…¥åŠ›ã€ã‚‚ä½¿ãˆã¾ã™ã€‚"
        : "çµ‚äº†ãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã¯å›ºå®šã§ã™ã€‚â‘¥çµ‚äº†å…¥åŠ› â†’ â‘¦å®´ä¼šã‚’å®Œäº†ã—ã¦ä¿å­˜ã€‚";

    // â‘¤é–‹å§‹ç¢ºå®šå¾Œã¯ãƒ¡ã‚¿æƒ…å ±ã‚’ãƒ­ãƒƒã‚¯ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
    const lock = (stage === "end");
    ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => {
      const el = $(id);
      if(!el) return;
      el.disabled = lock;
    });

    updateDraftInfoUI("");
  }

  // ===== master / events =====
  async function loadMaster(){
    const u = await refreshAuthState();
    if(!u) return;

    const row = await ensureMasterRow();
    master = row.payload || { version:1, items:[] };
    masterRowUpdatedAt = row.updated_at || null;
    $("masterUpdated").textContent = masterRowUpdatedAt || "â€”";

    initQtyMaps();
    renderMaster();
    renderProducts();
    recalcKpi();
  }

  async function saveMaster(){
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    master.lastSavedAt = new Date().toISOString();
    master.lastSavedBy = getOrCreateDeviceId();

    const { data, error } = await sb
      .from("docs")
      .upsert({
        user_id: u.id,
        kind: "master",
        doc_key: "main",
        payload: master
      }, { onConflict: "user_id,kind,doc_key" })
      .select("updated_at")
      .single();

    if(error){
      log("saveMaster error", error);
      return alert("ãƒã‚¹ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
    masterRowUpdatedAt = data.updated_at || null;
    $("masterUpdated").textContent = masterRowUpdatedAt || "â€”";
    alert("ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¦åŒæœŸã—ã¾ã—ãŸ");

    initQtyMaps();
    renderProducts();
    recalcKpi();
    scheduleDraftSave();
  }

  async function loadEvents(){
    const u = await refreshAuthState();
    if(!u) return;

    const { data, error } = await sb
      .from("docs")
      .select("doc_key, payload, created_at, updated_at")
      .eq("kind", "event")
      .order("created_at", { ascending: false })
      .limit(400);

    if(error){
      log("loadEvents error", error);
      return alert("å®´ä¼šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
    events = data || [];
    $("eventsCount").textContent = String(events.length);
    renderEvents();
  }

  // ===== ç›®å®‰ä¸€æ‹¬å…¥åŠ›ï¼ˆé–‹å§‹ï¼‰ =====
  function applyMinToAllStarts(){
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    if(stage !== "start"){
      alert("ç›®å®‰ä¸€æ‹¬å…¥åŠ›ã¯ã€Œâ‘£é–‹å§‹å…¥åŠ›ã€ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ãˆã¾ã™ã€‚");
      return;
    }
    const items = master.items || [];
    if(!items.length){
      alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚");
      return;
    }

    const targets = items
      .map(it => ({ id: it.id, name: it.name, minQty: it.minQty }))
      .filter(x => x.minQty !== null && x.minQty !== undefined && Number(x.minQty) > 0);

    if(!targets.length){
      alert("ãƒã‚¹ã‚¿ã®ã€Œæœ€ä½ç”¨æ„æ•°ï¼ˆç›®å®‰ï¼‰ã€ãŒè¨­å®šã•ã‚ŒãŸå•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const msg =
      `ãƒã‚¹ã‚¿ã®ç›®å®‰ï¼ˆæœ€ä½ç”¨æ„æ•°ï¼‰ã¾ã§ã€é–‹å§‹åœ¨åº«ã‚’ä¸€æ‹¬å…¥åŠ›ã—ã¾ã™ã€‚\n` +
      `å¯¾è±¡ï¼š${targets.length}å“\n` +
      `â€»å¯¾è±¡å•†å“ã®é–‹å§‹å…¥åŠ›ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

    if(!confirm(msg)) return;

    for(const t of targets){
      start10[t.id] = to10(t.minQty);
    }

    renderProducts();
    recalcKpi();
    scheduleDraftSave();
    alert("ç›®å®‰ã¾ã§ä¸€æ‹¬å…¥åŠ›ã—ã¾ã—ãŸï¼ˆé–‹å§‹ï¼‰ã€‚");
  }

  // ===== render master =====
  function renderMaster(){
    const box = $("masterList");
    box.innerHTML = "";
    const items = master.items || [];
    $("noMaster").style.display = items.length ? "none" : "";

    items.forEach((it) => {
      const minQty = (it.minQty === null || it.minQty === undefined) ? null : Number(it.minQty);
      const minText = (minQty !== null && Number.isFinite(minQty) && minQty > 0) ? `${minQty.toFixed(1)}${escapeHtml(it.unit || "æœ¬")}` : "â€”";

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${escapeHtml(it.name)}</h3>
            <div class="small">${escapeHtml(it.category || "")}${it.category ? " / " : ""}${escapeHtml(it.note || "")}</div>
            <div class="small">
              å˜ä½ï¼š${escapeHtml(it.unit || "æœ¬")} / å˜ä¾¡ï¼š<span class="mono">${yen(Number(it.costYen||0))}</span>
              / æœ€ä½ç”¨æ„ï¼š<span class="mono">${minText}</span>
            </div>
          </div>
          <div><span class="badge">ID: ${escapeHtml(it.id)}</span></div>
        </div>
        <div class="btnbar">
          <button data-act="edit">ç·¨é›†</button>
          <button class="danger" data-act="del">å‰Šé™¤</button>
        </div>
      `;
      el.querySelector('[data-act="del"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
        if(!confirm(`ã€Œ${it.name}ã€ã‚’ãƒã‚¹ã‚¿ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        master.items = master.items.filter(x => x.id !== it.id);
        delete start10[it.id];
        delete end10[it.id];
        renderMaster();
        renderProducts();
        recalcKpi();
        scheduleDraftSave();
      });
      el.querySelector('[data-act="edit"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
        const name = prompt("å•†å“å", it.name);
        if(name === null) return;
        const unit = prompt("å˜ä½ï¼ˆä¾‹ï¼šæœ¬/æ¨½/ç¼¶ï¼‰", it.unit || "æœ¬");
        if(unit === null) return;
        const cost = prompt("ä»•å…¥å˜ä¾¡ï¼ˆå††/1å˜ä½ï¼‰", String(it.costYen ?? ""));
        if(cost === null) return;

        const costYen = parseNumberSafe(cost);
        if(costYen === null || costYen < 0) return alert("å˜ä¾¡ãŒä¸æ­£ã§ã™");

        const min = prompt("æœ€ä½ç”¨æ„æ•°ï¼ˆæœ¬ï¼‰â€»0.1åˆ»ã¿OKã€ç©ºæ¬„ã§æœªè¨­å®š", (it.minQty ?? "") === null ? "" : String(it.minQty ?? ""));
        if(min === null) return;
        let minQty2 = null;
        if(String(min).trim() !== ""){
          const n = parseNumberSafe(min);
          if(n === null || n < 0) return alert("æœ€ä½ç”¨æ„æ•°ãŒä¸æ­£ã§ã™");
          minQty2 = Number(n.toFixed(1));
        }

        it.name = name.trim() || it.name;
        it.unit = (unit.trim() || "æœ¬");
        it.costYen = costYen;
        it.minQty = minQty2;

        it.category = prompt("ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰", it.category || "")?.trim() ?? it.category;
        it.note = prompt("å‚™è€ƒï¼ˆä»»æ„ï¼‰", it.note || "")?.trim() ?? it.note;

        renderMaster();
        renderProducts();
        recalcKpi();
        scheduleDraftSave();
      });
      box.appendChild(el);
    });
  }

  function calcItemCost(itemId){
    const it = (master.items || []).find(x => x.id === itemId);
    if(!it) return 0;
    const s = start10[itemId] || 0;
    const e = end10[itemId];
    if(e === null || e === undefined) return 0;
    const used = (s - e) / 10;
    if(used <= 0) return 0;
    return Math.round(used * Number(it.costYen || 0));
  }

  // ===== render products =====
  function renderProducts(){
    const box = $("products");
    box.innerHTML = "";
    const items = master.items || [];
    $("noProducts").style.display = items.length ? "none" : "";

    items.forEach(it => {
      if(start10[it.id] === undefined) start10[it.id] = 0;
      if(end10[it.id] === undefined) end10[it.id] = null;

      const s10 = start10[it.id] || 0;
      const e10 = end10[it.id];
      const used10 = (e10 === null || e10 === undefined) ? null : (s10 - e10);

      const usedText = (used10 === null) ? "â€”" : (used10/10).toFixed(1);
      const usedClass = (used10 === null) ? "missing" : (used10 < 0 ? "negative" : "");

      const minQty = (it.minQty === null || it.minQty === undefined) ? null : Number(it.minQty);
      const min10 = (minQty !== null && Number.isFinite(minQty)) ? to10(minQty) : null;
      const shortage = (min10 !== null && min10 > 0) ? (s10 < min10) : false;

      const shortageBadge = shortage
        ? `<span class="badge warn" title="é–‹å§‹åœ¨åº«ãŒæœ€ä½ç”¨æ„æ•°ã‚ˆã‚Šå°‘ãªã„">âš  ä¸è¶³</span>`
        : (min10 !== null && min10 > 0 ? `<span class="badge">ç›®å®‰OK</span>` : `<span class="badge">ç›®å®‰ãªã—</span>`);

      const metaMin = (min10 !== null && min10 > 0)
        ? `æœ€ä½ç”¨æ„ ${minQty.toFixed(1)}${escapeHtml(it.unit||"æœ¬")}`
        : `æœ€ä½ç”¨æ„ â€”`;

      const startBox = (stage === "start")
        ? `
          <div class="ctrlBox startBox startArea">
            <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono">${(s10/10).toFixed(1)}</span></div>
            <div class="ctrlGrid">
              <div class="stepBtn" data-field="start" data-step="-10">âˆ’1</div>
              <div class="stepBtn" data-field="start" data-step="-1">âˆ’0.1</div>
              <input class="qtyInput" data-field="startInput" inputmode="decimal" placeholder="0.0" value="${(s10/10).toFixed(1)}" />
              <div class="stepBtn primary" data-field="start" data-step="1">+0.1</div>
              <div class="stepBtn primary" data-field="start" data-step="10">+1</div>
            </div>
          </div>
        `
        : `
          <div class="ctrlBox startBox startArea readonly">
            <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå›ºå®šï¼‰</span><span class="mono">${(s10/10).toFixed(1)}</span></div>
            <div class="roQty mono">${(s10/10).toFixed(1)}</div>
            <div class="small">é–‹å§‹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
          </div>
        `;

      const endBox = (stage === "end")
        ? `
          <div class="ctrlBox endBox endArea">
            <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono">${(e10 === null || e10 === undefined) ? "â€”" : (e10/10).toFixed(1)}</span></div>
            <div class="ctrlGrid">
              <div class="stepBtn" data-field="end" data-step="-10">âˆ’1</div>
              <div class="stepBtn" data-field="end" data-step="-1">âˆ’0.1</div>
              <input class="qtyInput" data-field="endInput" inputmode="decimal" placeholder="â€”" value="${(e10 === null || e10 === undefined) ? "" : (e10/10).toFixed(1)}" />
              <div class="stepBtn primary" data-field="end" data-step="1">+0.1</div>
              <div class="stepBtn primary" data-field="end" data-step="10">+1</div>
            </div>
          </div>
        `
        : `
          <div class="ctrlBox endBox endArea readonly">
            <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå¾Œã§ï¼‰</span><span class="mono">â€”</span></div>
            <div class="roQty mono">â€”</div>
            <div class="small">â‘¤é–‹å§‹ç¢ºå®šå¾Œã«å…¥åŠ›ã—ã¾ã™</div>
          </div>
        `;

      const row = document.createElement("div");
      row.className = "prodRow";
      row.innerHTML = `
        <div>
          <div class="prodName">${escapeHtml(it.name)}</div>
          <div class="prodMeta">
            ${escapeHtml(metaMin)} / å˜ä¾¡ ${yen(Number(it.costYen||0))} / å˜ä½ ${escapeHtml(it.unit||"æœ¬")} / ${escapeHtml(it.category||"-")}
            &nbsp; ${shortageBadge}
          </div>
        </div>

        <div class="controls" data-itemid="${escapeHtml(it.id)}">
          ${startBox}
          ${endBox}

          <div class="usedBox usedArea">
            <div class="usedLine">ä½¿ç”¨ï¼ˆé–‹å§‹âˆ’çµ‚äº†ï¼‰</div>
            <div class="usedVal ${usedClass} mono">${usedText}</div>
            <div class="usedLine">åŸä¾¡ï¼š<span class="mono">${yen(calcItemCost(it.id))}</span></div>
          </div>
        </div>
      `;
      box.appendChild(row);
    });

    // delegation
    box.onclick = (ev) => {
      if(mustReload) return;
      const btn = ev.target.closest(".stepBtn");
      if(!btn) return;

      const ctrl = btn.closest(".controls");
      if(!ctrl) return;

      const itemId = ctrl.getAttribute("data-itemid");
      const step = parseInt(btn.getAttribute("data-step"), 10) || 0;
      const field = btn.getAttribute("data-field");

      if(field === "start"){
        if(stage !== "start") return;
        const now = start10[itemId] || 0;
        start10[itemId] = Math.max(0, now + step);
      }else if(field === "end"){
        if(stage !== "end") return;
        const now = (end10[itemId] === null || end10[itemId] === undefined) ? 0 : (end10[itemId] || 0);
        end10[itemId] = Math.max(0, now + step);
      }
      renderProducts();
      recalcKpi();
      scheduleDraftSave();
    };

    box.onchange = (ev) => {
      if(mustReload) return;
      const inp = ev.target.closest(".qtyInput");
      if(!inp) return;

      const ctrl = inp.closest(".controls");
      const itemId = ctrl.getAttribute("data-itemid");
      const f = inp.getAttribute("data-field");
      const val = (inp.value || "").trim();

      if(f === "startInput"){
        if(stage !== "start") return;
        const n = parseNumberSafe(val);
        start10[itemId] = Math.max(0, to10(n || 0));
      }else if(f === "endInput"){
        if(stage !== "end") return;
        if(val === ""){
          end10[itemId] = null;
        }else{
          const n = parseNumberSafe(val);
          end10[itemId] = Math.max(0, to10(n || 0));
        }
      }
      renderProducts();
      recalcKpi();
      scheduleDraftSave();
    };
  }

  // ===== events list =====
  function renderEvents(){
    const box = $("events");
    box.innerHTML = "";

    const from = $("fFrom").value || null;
    const to = $("fTo").value || null;

    const filtered = (events || []).filter(e => {
      const d = e.payload?.date;
      if(!d) return true;
      if(from && d < from) return false;
      if(to && d > to) return false;
      return true;
    });

    $("noEvents").style.display = filtered.length ? "none" : "";

    let sumCostComplete = 0;
    let sumSalesComplete = 0;
    let sumGuests = 0;

    filtered.forEach(e => {
      const p = e.payload || {};
      const date = p.date || "-";
      const guests = p.guests ?? null;

      const cost = Number(p.totalCostYen ?? 0);
      const sales = (p.salesYen === null || p.salesYen === undefined) ? null : Number(p.salesYen);
      const missingEnds = Number(p.missingEnds ?? 0);
      const isComplete = !!p.isComplete;

      if(isComplete){
        sumCostComplete += cost;
        if(sales !== null) sumSalesComplete += sales;
        if(guests && guests > 0) sumGuests += guests;
      }

      const duration = p.durationMin ? `${p.durationMin}åˆ†` : "â€”";
      const style = p.style === "standing" ? "ç«‹é£Ÿ" : "ç€å¸­";
      const staff = (p.staff || []).join(" / ") || "â€”";

      const perHeadPrice = (p.drinkPricePerHeadYen ?? null);
      const perHeadText = (perHeadPrice && Number(perHeadPrice) > 0) ? yen(perHeadPrice) : "â€”";

      const rate = (sales && sales > 0) ? (cost / sales) : null;

      const badge = isComplete
        ? `<span class="badge">ç¢ºå®š</span>`
        : `<span class="badge warn">æœªç¢ºå®šï¼ˆæœªå…¥åŠ›${missingEnds}ï¼‰</span>`;

      const title = `${date}ã€€${guests ? guests + "å" : "äººæ•°â€”"}ã€€${badge}`;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${title}</h3>
            <div class="small">å˜ä¾¡ï¼š<span class="mono">${escapeHtml(perHeadText)}</span> / æ™‚é–“ï¼š${escapeHtml(duration)} / å½¢æ…‹ï¼š${escapeHtml(style)} / æ‹…å½“ï¼š${escapeHtml(staff)}</div>
            <div class="small">
              å£²ä¸Šï¼š<span class="mono">${sales === null ? "â€”" : yen(sales)}</span>
              / åŸä¾¡ï¼š<span class="mono">${yen(cost)}</span>
              / åŸä¾¡ç‡ï¼š<span class="mono">${rate === null ? "â€”" : pct(rate)}</span>
            </div>
          </div>
          <div><span class="badge">updated: ${escapeHtml(e.updated_at || "-")}</span></div>
        </div>
      `;
      box.appendChild(el);
    });

    $("kpiSumCostComplete").textContent = yen(sumCostComplete);
    $("kpiSumSalesComplete").textContent = yen(sumSalesComplete);
    $("kpiSumCostRateComplete").textContent = (sumSalesComplete > 0) ? pct(sumCostComplete / sumSalesComplete) : "â€”";
    $("kpiSumGuests").textContent = String(sumGuests);
    $("kpiAvgPerHead").textContent = (sumGuests > 0) ? `å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰ ${yen(sumCostComplete / sumGuests)}` : "â€”";
  }

  // ===== flow actions =====
  function ensureDraftInitialized(){
    if(!$("evDate").value) $("evDate").value = todayISO();
    if($("evExt").value === "") $("evExt").value = "0";
    updateDurationUI();
    initQtyMaps();
    updateStageUI();
    renderProducts();
    recalcKpi();
    scheduleDraftSave();
  }

  // â˜…å®Ÿè£…ï¼šâ‘¤é–‹å§‹ç¢ºå®šæ™‚ã«ã€Œç›®å®‰ã‚ã‚Šãªã®ã«é–‹å§‹0ã€ã‚’è­¦å‘Š
  function warnMinButStartZero(){
    const items = master.items || [];
    const zeros = items.filter(it => {
      const hasMin = it.minQty !== null && it.minQty !== undefined && Number(it.minQty) > 0;
      if(!hasMin) return false;
      const s = start10[it.id] || 0;
      return s === 0;
    });

    if(!zeros.length) return true;

    const showNames = zeros.slice(0, 8).map(x => `ãƒ»${x.name}`).join("\n");
    const more = zeros.length > 8 ? `\nâ€¦ä»– ${zeros.length - 8} ä»¶` : "";
    const msg =
      `ã€è­¦å‘Šã€‘æœ€ä½ç”¨æ„æ•°ï¼ˆç›®å®‰ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã«ã€é–‹å§‹ãŒ0ã®å“ãŒã‚ã‚Šã¾ã™ã€‚\n` +
      `ã“ã®ã¾ã¾â‘¤é–‹å§‹ç¢ºå®šã™ã‚‹ã¨ã€Œå…¥ã‚Œå¿˜ã‚Œã€ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\n` +
      `${showNames}${more}\n\n` +
      `ãã‚Œã§ã‚‚â‘¤é–‹å§‹ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`;

    return confirm(msg);
  }

  async function confirmStart(){
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    if(!master.items?.length) return alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");

    const date = $("evDate").value || "";
    if(!date) return alert("æ—¥ä»˜ã‚’å…¥ã‚Œã¦ãã ã•ã„");

    // â˜…è­¦å‘Šï¼ˆç›®å®‰ã‚ã‚Šé–‹å§‹0ï¼‰
    if(!warnMinButStartZero()) return;

    if(!confirm("â‘¤é–‹å§‹ã‚’ç¢ºå®šã—ã¾ã™ã€‚ä»¥å¾Œã€é–‹å§‹æ•°é‡ã¨å®´ä¼šæƒ…å ±ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

    stage = "end";
    (master.items || []).forEach(it => { end10[it.id] = null; });

    updateStageUI();
    renderProducts();
    recalcKpi();
    scheduleDraftSave();

    await saveRemoteDraft();
  }

  async function backToStart(){
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    if(!confirm("é–‹å§‹ã‚’ç·¨é›†ã—ç›´ã—ã¾ã™ã€‚ç¾åœ¨ã®çµ‚äº†å…¥åŠ›ã¯ç ´æ£„ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    stage = "start";
    (master.items || []).forEach(it => end10[it.id] = null);

    updateStageUI();
    renderProducts();
    recalcKpi();
    scheduleDraftSave();
    await saveRemoteDraft();
  }

  function buildEventPayloadFromDraft(){
    const m = {
      date: $("evDate").value || todayISO(),
      guests: parseIntSafe($("evGuests").value),
      drinkPricePerHeadYen: parseIntSafe($("evDrinkPrice").value),
      extensionCount: Math.max(0, parseIntSafe($("evExt").value) || 0),
      style: $("evStyle").value,
      staff: ($("evStaff").value || "").split(",").map(s=>s.trim()).filter(Boolean).slice(0,2)
    };
    const salesYen = (m.guests && m.drinkPricePerHeadYen) ? (m.guests * m.drinkPricePerHeadYen) : null;
    const durationMin = 90 + 30 * m.extensionCount;

    const items = [];
    let totalCostYen = 0;
    let missingEnds = 0;
    let negativeCount = 0;

    for(const it of (master.items || [])){
      const s10 = start10[it.id] || 0;
      const e10 = end10[it.id];

      const hasStart = s10 !== 0;
      const hasEnd = !(e10 === null || e10 === undefined);
      if(!hasStart && !hasEnd) continue;

      let used10 = null;
      let costItemYen = 0;

      if(!hasEnd){
        missingEnds++;
      }else{
        used10 = s10 - e10;
        if(used10 < 0) negativeCount++;
        const used = used10 / 10;
        if(used > 0){
          costItemYen = Math.round(used * Number(it.costYen || 0));
          totalCostYen += costItemYen;
        }
      }

      items.push({
        itemId: it.id,
        startQty: Number((s10/10).toFixed(1)),
        endQty: hasEnd ? Number((e10/10).toFixed(1)) : null,
        usedQty: (used10 === null) ? null : Number((used10/10).toFixed(1)),
        costItemYen
      });
    }

    const isComplete = (missingEnds === 0);
    const costRate = (salesYen && salesYen > 0) ? (totalCostYen / salesYen) : null;

    return {
      version: 2,
      date: m.date,
      guests: m.guests ?? null,
      drinkPricePerHeadYen: m.drinkPricePerHeadYen ?? null,
      salesYen,
      costRate,
      drinkBaseMin: 90,
      extensionCount: m.extensionCount,
      durationMin,
      style: m.style,
      staff: m.staff,
      items,
      totalCostYen: Math.round(totalCostYen),
      missingEnds,
      negativeCount,
      isComplete,
      savedAt: new Date().toISOString(),
      savedBy: getOrCreateDeviceId()
    };
  }

  async function finishEvent(){
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    if(stage !== "end") return alert("ã¾ãšâ‘¤é–‹å§‹ç¢ºå®šã—ã¦ã€â‘¥çµ‚äº†å…¥åŠ›ã«é€²ã‚“ã§ãã ã•ã„ã€‚");

    const payload = buildEventPayloadFromDraft();
    if(payload.missingEnds > 0){
      if(!confirm(`çµ‚äº†æœªå…¥åŠ›ã®å•†å“ãŒ ${payload.missingEnds} ä»¶ã‚ã‚Šã¾ã™ã€‚\nã“ã®ã¾ã¾ä¿å­˜ã™ã‚‹ã¨ã€Œæœªç¢ºå®šã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    }

    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
    const { error } = await sb
      .from("docs")
      .upsert({
        user_id: u.id,
        kind: "event",
        doc_key: id,
        payload
      }, { onConflict: "user_id,kind,doc_key" });

    if(error){
      log("finishEvent save error", error);
      return alert("å®´ä¼šä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }

    await clearDraftAll(true);
    alert("â‘¦å®´ä¼šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå®Œäº†ï¼‰");
    await loadEvents();
  }

  async function clearDraftAll(silent=false){
    clearLocalDraft();

    stage = "start";
    start10 = {};
    end10 = {};
    draftSavedAt = null;
    draftSavedBy = null;
    draftServerUpdatedAt = null;
    draftDirty = false;

    $("evDate").value = todayISO();
    $("evGuests").value = "";
    $("evDrinkPrice").value = "";
    $("evExt").value = "0";
    $("evStyle").value = "seated";
    $("evStaff").value = "";
    updateDurationUI();

    const u = await getUser();
    if(u){
      const { error } = await sb
        .from("docs")
        .delete()
        .eq("kind", DRAFT_KIND)
        .eq("doc_key", DRAFT_KEY);
      if(error) log("remote draft delete error", error);
    }

    initQtyMaps();
    updateStageUI();
    renderProducts();
    recalcKpi();

    if(!silent) alert("ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  async function loadDraftPreferNewer(){
    const local = loadLocalDraft();
    const remote = await loadRemoteDraft();

    const localAt = local?.savedAt ? Date.parse(local.savedAt) : 0;
    const remoteAt = remote?.savedAt ? Date.parse(remote.savedAt) : 0;

    if(remote && remoteAt >= localAt){
      applyDraftPayload(remote);
      saveLocalDraft(remote);
      updateDraftInfoUI("serveræ¡ç”¨");
      return;
    }
    if(local){
      applyDraftPayload(local);
      updateDraftInfoUI("localæ¡ç”¨");
      return;
    }

    ensureDraftInitialized();
    updateDraftInfoUI("æ–°è¦");
  }

  // ===== UI handlers =====
  $("btnLogin").addEventListener("click", async () => {
    const email = ($("email").value || "").trim();
    const password = $("pw").value || "";
    if(!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦");

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      log("login failed", error);
      return alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
    }

    // â˜…ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯å¿…ãšâ‘¡ã‚’è¸ã¾ã›ã‚‹
    await refreshAuthState();
    setMustReload(true);
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã—ãŸã€‚æ¬¡ã«â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆå¿…é ˆï¼‰ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  });

  $("btnLogout").addEventListener("click", async () => {
    await sb.auth.signOut();
    await refreshAuthState();
    setMustReload(false); // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨é€”ï¼‰
  });

  $("btnStageStart").addEventListener("click", () => {
    if(stage === "start") return;
    backToStart().catch(()=>{});
  });
  $("btnStageEnd").addEventListener("click", () => {
    if(stage === "end") return;
    confirmStart().catch(()=>{});
  });

  $("btnConfirmStart").addEventListener("click", () => confirmStart().catch(()=>{}));
  $("btnBackToStart").addEventListener("click", () => backToStart().catch(()=>{}));
  $("btnFinishEvent").addEventListener("click", () => finishEvent().catch(()=>{}));

  $("btnDraftSave").addEventListener("click", async () => {
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    scheduleDraftSave();
    await saveRemoteDraft();
    alert("é€”ä¸­ä¿å­˜ã—ã¾ã—ãŸï¼ˆåŒæœŸï¼‰");
  });

  $("btnDraftClear").addEventListener("click", async () => {
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    if(!confirm("ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã€‚é–‹å§‹/çµ‚äº†ã®å…¥åŠ›å†…å®¹ã¯æ¶ˆãˆã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    await clearDraftAll(false);
  });

  // â˜…ç›®å®‰ä¸€æ‹¬å…¥åŠ›
  $("btnAutofillMin").addEventListener("click", () => applyMinToAllStarts());

  // meta auto-save
  ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => {
    $(id).addEventListener("input", () => {
      if(mustReload) return;
      updateDurationUI();
      recalcKpi();
      scheduleDraftSave();
    });
    $(id).addEventListener("change", () => {
      if(mustReload) return;
      updateDurationUI();
      recalcKpi();
      scheduleDraftSave();
    });
  });

  $("btnClearFilter").addEventListener("click", () => {
    $("fFrom").value = "";
    $("fTo").value = "";
    renderEvents();
  });
  $("fFrom").addEventListener("change", renderEvents);
  $("fTo").addEventListener("change", renderEvents);

  // master add
  $("btnAddMaster").addEventListener("click", () => {
    if(mustReload) return alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    const name = ($("mName").value || "").trim();
    const unit = ($("mUnit").value || "æœ¬").trim() || "æœ¬";
    const costYen = parseNumberSafe($("mCost").value);
    const minRaw = ($("mMin").value || "").trim();
    const category = ($("mCat").value || "").trim();
    const note = ($("mNote").value || "").trim();

    if(!name) return alert("å•†å“åã‚’å…¥åŠ›ã—ã¦");
    if(costYen === null || costYen < 0) return alert("ä»•å…¥å˜ä¾¡ï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¦");

    let minQty = null;
    if(minRaw !== ""){
      const n = parseNumberSafe(minRaw);
      if(n === null || n < 0) return alert("æœ€ä½ç”¨æ„æ•°ãŒä¸æ­£ã§ã™");
      minQty = Number(n.toFixed(1));
    }

    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
    master.items = master.items || [];
    master.items.unshift({ id, name, unit, costYen, minQty, category, note });

    $("mName").value = "";
    $("mUnit").value = "æœ¬";
    $("mCost").value = "";
    $("mMin").value = "";
    $("mCat").value = "";
    $("mNote").value = "";

    start10[id] = 0;
    end10[id] = null;

    renderMaster();
    renderProducts();
    recalcKpi();
    scheduleDraftSave();
  });

  $("btnSaveMaster").addEventListener("click", saveMaster);

  $("btnDump").addEventListener("click", () => {
    log("dump", {
      mustReload,
      stage, draftSavedAt, draftSavedBy, draftServerUpdatedAt, draftDirty,
      masterCount: master.items?.length || 0,
      eventsCount: events.length,
      start10, end10
    });
  });

  // ===== realtime =====
  let rtChannel = null;
  function subscribeRealtime(){
    if(rtChannel) return;

    rtChannel = sb.channel("banquet-docs-sync");
    rtChannel.on("postgres_changes", { event:"*", schema:"public", table:"docs" }, (payload) => {
      const n = payload.new;
      if(!n) return;

      if(n.kind === "master" && n.doc_key === "main"){
        loadMaster().catch(e => log("loadMaster failed", e));
      }
      if(n.kind === "event"){
        loadEvents().catch(e => log("loadEvents failed", e));
      }
      if(n.kind === DRAFT_KIND && n.doc_key === DRAFT_KEY){
        loadDraftPreferNewer().catch(e => log("loadDraftPreferNewer failed", e));
      }
    }).subscribe((status) => {
      $("rtState").textContent = status;
      log("realtime subscribe", { status });
    });
  }

  async function reloadAllCore(){
    subscribeRealtime();
    await loadMaster();
    await loadEvents();
    await loadDraftPreferNewer();
  }

  // â‘¡ãƒœã‚¿ãƒ³ï¼šå¿…é ˆå†èª­ã¿è¾¼ã¿
  $("btnReloadNow").addEventListener("click", async () => {
    const u = await getUser();
    if(!u) return alert("å…ˆã«â‘ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");

    try{
      await reloadAllCore();
      setMustReload(false);
      alert("â‘¡ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿å®Œäº†ã€‚â‘¢å®´ä¼šæƒ…å ± â†’ â‘£å•†å“å…¥åŠ›ã¸é€²ã‚“ã§ãã ã•ã„ã€‚");
    }catch(e){
      log("reloadAllCore failed", e);
      alert("å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e?.message || e));
    }
  });

  // initial
  $("evDate").value = todayISO();
  $("evExt").value = "0";
  updateDurationUI();
  updateStageUI();
  refreshAuthState().then(async () => {
    const u = await getUser();

    // æ—¢ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã‚‚ã€Œâ‘¡å¿…é ˆã€ã«ã™ã‚‹ï¼ˆç¾å ´äº‹æ•…é˜²æ­¢ï¼‰
    if(u){
      setMustReload(true);
      // ãƒ­ãƒ¼ã‚«ãƒ«ä¸‹æ›¸ãã¯èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã ã‘ã¯ã™ã‚‹ï¼ˆã§ã‚‚ãƒ­ãƒƒã‚¯ï¼‰
      const local = loadLocalDraft();
      if(local) applyDraftPayload(local);
      else ensureDraftInitialized();
    }else{
      setMustReload(false);
      const local = loadLocalDraft();
      if(local) applyDraftPayload(local);
      else ensureDraftInitialized();
    }
  });

})();
</script>
</body>
</html>
