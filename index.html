<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>宴会アプリ（土台A：JSON1枚同期）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;max-width:960px;margin:18px auto;padding:0 12px}
    h1{font-size:18px;margin:0 0 12px}
    input,button,textarea{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ddd}
    button{cursor:pointer;background:#111;color:#fff;border-color:#111}
    button.secondary{background:#fff;color:#111}
    button.warn{background:#b00020;border-color:#b00020}
    textarea{width:100%;min-height:360px;margin-top:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;background:#fafafa}
    .muted{color:#666;font-size:12px}
    hr{margin:14px 0;border:0;border-top:1px solid #eee}
    pre{background:#0b0b0c;color:#f2f3f4;padding:10px;border-radius:12px;overflow:auto}
  </style>
</head>
<body>
  <h1>宴会アプリ（土台A：JSON1枚同期）</h1>

  <div class="row">
    <input id="email" type="email" placeholder="店舗共通メール" style="flex:1;min-width:240px" />
    <input id="pw" type="password" placeholder="パスワード" style="min-width:180px" />
    <button id="btnLogin">ログイン</button>
    <button id="btnLogout" class="secondary">ログアウト</button>
    <span class="pill" id="status">未ログイン</span>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnLoad" class="secondary">最新を読み込み</button>
    <button id="btnSave">保存（上書き）</button>
    <button id="btnSeed" class="secondary">サンプルJSON</button>
    <button id="btnResetLocal" class="warn">端末ローカルID再生成</button>

    <label class="row" style="gap:6px;">
      <input id="autoPull" type="checkbox" checked />
      <span class="muted">他端末の更新を自動反映（Realtime）</span>
    </label>
  </div>

  <div class="muted" style="margin-top:8px;">
    A方式は「最後に保存した端末が勝つ（last-write-wins）」です。まず同期土台だけ作って、仕様が固まったら event 分割に拡張できます。
  </div>

  <hr/>

  <div class="row">
    <span class="pill">kind: <b>app_state</b></span>
    <span class="pill">doc_key: <b>main</b></span>
    <span class="pill">device_id: <b id="deviceId">—</b></span>
    <span class="pill">updated_at: <b id="updatedAt">—</b></span>
  </div>

  <textarea id="json" spellcheck="false" placeholder="ここに状態JSONが入ります（保存で同期）"></textarea>

  <div class="muted" style="margin-top:10px;">ログ/エラー</div>
  <pre id="log">-</pre>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ====== ここだけ自分の値に差し替え（Supabase Project Settings → API） ======
    const SUPABASE_URL = "https://pftjjrluhdbovoaxnykn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdGpqcmx1aGRib3ZvYXhueWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzUzMTUsImV4cCI6MjA4NjcxMTMxNX0.qX-LpvYcbu589h96FdxJmUEqYto64wniBcuGXraJaoU";
    // ======================================================================

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const KIND = "app_state";
    const DOC_KEY = "main";

    const $ = (id) => document.getElementById(id);

    function log(msg, obj){
      const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj, null, 2)}` : "");
      $("log").textContent = line + "\n\n" + $("log").textContent;
    }
    function setStatus(s){ $("status").textContent = s; }

    // 端末識別（payloadに残す用）
    const DID_KEY = "banquet_device_id";
    function getOrCreateDeviceId(){
      let did = localStorage.getItem(DID_KEY);
      if(!did){
        did = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
        localStorage.setItem(DID_KEY, did);
      }
      return did;
    }
    function setDeviceIdUI(){
      $("deviceId").textContent = getOrCreateDeviceId();
    }
    setDeviceIdUI();

    function safeParseJSON(text){
      try { return { ok:true, val: JSON.parse(text) }; }
      catch(e){ return { ok:false, err: e }; }
    }

    async function getUser(){
      const { data, error } = await sb.auth.getUser();
      if(error) log("auth.getUser error", error);
      return data?.user || null;
    }

    // app_state 行を必ず1つ用意
    async function ensureRow(){
      const user = await getUser();
      if(!user) return null;

      const { data, error } = await sb
        .from("docs")
        .select("id, kind, doc_key, payload, updated_at")
        .eq("kind", KIND)
        .eq("doc_key", DOC_KEY)
        .limit(1)
        .maybeSingle();

      if(error) throw error;

      if(!data){
        const deviceId = getOrCreateDeviceId();
        const seed = {
          version: 1,
          note: "A方式: JSON1枚の同期。payloadは自由に変えてOK。",
          createdAt: new Date().toISOString(),
          lastSavedAt: null,
          lastSavedBy: deviceId,
          master: { items: [] },
          draft: {},
          history: []
        };

        const ins = await sb
          .from("docs")
          .insert({ kind: KIND, doc_key: DOC_KEY, payload: seed })
          .select("id, kind, doc_key, payload, updated_at")
          .single();

        if(ins.error) throw ins.error;
        return ins.data;
      }

      return data;
    }

    async function loadLatest(){
      const user = await getUser();
      if(!user){
        setStatus("未ログイン");
        $("updatedAt").textContent = "—";
        $("json").value = "";
        return;
      }
      setStatus("ログイン中: " + (user.email || "(no email)"));

      try{
        const row = await ensureRow();
        $("updatedAt").textContent = row.updated_at || "—";
        $("json").value = JSON.stringify(row.payload ?? {}, null, 2);
        log("loaded latest", { updated_at: row.updated_at, id: row.id });
      }catch(e){
        log("loadLatest error", e);
        alert("読み込みエラー: " + (e.message || e));
      }
    }

    async function saveOverwrite(){
      const user = await getUser();
      if(!user) return alert("先にログインして");

      const parsed = safeParseJSON($("json").value);
      if(!parsed.ok) return alert("JSONが壊れてる: " + parsed.err.message);

      const deviceId = getOrCreateDeviceId();
      const payload = parsed.val;
      payload.lastSavedAt = new Date().toISOString();
      payload.lastSavedBy = deviceId;

      try{
        const { data, error } = await sb
          .from("docs")
          .upsert(
            { kind: KIND, doc_key: DOC_KEY, payload },
            { onConflict: "user_id,kind,doc_key" }
          )
          .select("id, updated_at")
          .single();

        if(error) throw error;

        $("updatedAt").textContent = data.updated_at || "—";
        log("saved overwrite", data);
        alert("保存した（上書き）");
      }catch(e){
        log("saveOverwrite error", e);
        alert("保存エラー: " + (e.message || e));
      }
    }

    // ---- UI handlers ----
    $("btnLogin").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("pw").value;
      if(!email || !password) return alert("メールとパスワード入れて");

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){
        log("login failed", error);
        return alert("ログイン失敗: " + error.message);
      }
      log("login ok");
      await loadLatest();
    };

    $("btnLogout").onclick = async () => {
      await sb.auth.signOut();
      log("logout");
      await loadLatest();
    };

    $("btnLoad").onclick = loadLatest;
    $("btnSave").onclick = saveOverwrite;

    $("btnSeed").onclick = () => {
      const sample = {
        version: 1,
        note: "ここは自由。UI/商品が決まるまで仮置き。",
        master: { items: [] },
        draft: { event: null },
        history: [],
        settings: { decimals: 1 }
      };
      $("json").value = JSON.stringify(sample, null, 2);
      log("seeded sample json");
    };

    $("btnResetLocal").onclick = () => {
      if(!confirm("この端末のdevice_idを再生成しますか？（同期データ自体は消えません）")) return;
      localStorage.removeItem(DID_KEY);
      setDeviceIdUI();
      log("device_id regenerated", { deviceId: getOrCreateDeviceId() });
    };

    // ---- Realtime（他端末の更新を自動反映）----
    // ※SQLの publication 追加 or DashboardでdocsをRealtime対象にしてないと反応しません
    const ch = sb.channel("app-state-sync");
    ch.on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "docs"
    }, async (payload) => {
      if(!$("autoPull").checked) return;

      const newRow = payload.new;
      if(!newRow) return;

      // kind/doc_key が対象のときだけpull
      if(newRow.kind === KIND && newRow.doc_key === DOC_KEY){
        log("realtime change detected", { updated_at: newRow.updated_at });
        await loadLatest();
      }
    }).subscribe((status) => {
      log("realtime subscribe", { status });
    });

    sb.auth.onAuthStateChange((_event, _session) => loadLatest());

    // 初回
    loadLatest();
  </script>
</body>
</html>
